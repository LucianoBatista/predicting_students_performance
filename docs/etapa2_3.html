<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Etapa 2 e 3</title>

<script src="site_libs/header-attrs-2.4.6/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">DS</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="etapa1_eda.html">Etapa 1</a>
</li>
<li>
  <a href="etapa2_3.html">Etapa 2 e 3</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Etapa 2 e 3</h1>

</div>


<p>As etapas 2 e 3 foram destinadas para modelagem. O problema escolhido foi o de predizer o desempenho dos estudantes nas avaliações finais e além disso, o candidato deve avaliar a qualidade e precisão do modelo.</p>
<p>No entanto algumas ressalvas precisam ser feitas: em relação a task pedida, a documentação da OU (Open University) e a integridade dos dados.</p>
<p>As avaliações finais no dataset correspondem a classe <em>“Exam”</em>, presente na variável <code>assessment_type</code>. No entanto, possuímos muitos valores missing nesta variável e sua importância para composição da nota final é muitas vezes dúbia. Isso por que encontramos estudantes que pontuaram 0 no <code>Exam</code> e ainda assim foram aprovados, assim como estudantes que não fizeram o teste e foram aprovados do mesmo jeito.</p>
<p>Isso por que as avaliações finais servem para compor sua nota final, valor esse que de fato vai indicar se o estudante foi aprovado ou não no curso. E essa composição não é dita na documentação dos dados, e é pouco provável de ser encontrada apenas pela análise dos dados atuais.</p>
<p>Tem mais um ponto que precisa ser comentado, ao pensar em utilizar as notas individuais em cada avaliação encontrei outro problema. Alguns cursos zeraram os pesos de cada teste, gerando assim mais incosistências em relação a correlação de quem foi aprovado ou não e seu desempenho.</p>
<div id="libs" class="section level1">
<h1>Libs</h1>
<p>Abaixo você encontra os pacotes utilizados para esta etapa do case.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(skimr)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">library</span>(data.table)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw">library</span>(tidytable)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw">library</span>(data.table)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw">library</span>(lubridate)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="kw">library</span>(tidytext)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="kw">library</span>(ggridges)</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw">library</span>(sf)</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="kw">library</span>(geofacet)</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="kw">library</span>(rlang)</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="kw">library</span>(plotly)</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="kw">library</span>(tidymodels)</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="kw">library</span>(DT)</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="kw">library</span>(kableExtra)</span></code></pre></div>
</div>
<div id="procedimento-adotado" class="section level1">
<h1>Procedimento adotado</h1>
<p>Diante ao que foi dito, o procedimento adotado aqui foi o de retirar os valores missings da variável <code>assessment_type</code> e trabalhar com as informações que sobrarem. Sendo que essa é nossa variável target, não faria sentido utilizar nenhum método de imputação nela.</p>
<p>Para obter o dataset para modelagem precisamos realizar uma série de joins entre as tableas disponíveis, para que cada observação dos dados fosse composta por um estudante de um determinado período e curso diferente.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># obtendo o dataset para modelagem</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># primeira parte: dados apenas sobre as avaliações finais (Exam) </span></span>
<span id="cb2-3"><a href="#cb2-3"></a>final_score_exam_tbl &lt;-<span class="st"> </span>student_info <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="st">  </span><span class="co"># coletando pesos e ids das avaliações </span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="st">  </span><span class="kw">left_join</span>(assessments, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;code_module&quot;</span>, <span class="st">&quot;code_presentation&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>gender<span class="op">:-</span>disability, <span class="op">-</span>date) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="st">  </span><span class="co"># coletando as notas individuais dos estudantes</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="st">  </span><span class="kw">left_join</span>(student_assessment, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;id_student&quot;</span>, <span class="st">&quot;id_assessment&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">weighted =</span> (weight<span class="op">/</span><span class="dv">100</span>) <span class="op">*</span><span class="st"> </span>score) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="st">  </span><span class="kw">filter</span>(assessment_type <span class="op">==</span><span class="st"> &quot;Exam&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="st">  </span><span class="kw">drop_na</span>(score) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="st">  </span><span class="kw">group_by</span>(code_module, code_presentation, id_student, final_result) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">final_score_exam =</span> <span class="kw">sum</span>(weighted)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="st">  </span><span class="kw">ungroup</span>()</span></code></pre></div>
<pre><code>## `summarise()` regrouping output by &#39;code_module&#39;, &#39;code_presentation&#39;, &#39;id_student&#39; (override with `.groups` argument)</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># segunda parte: join dos dados sobre as avaliações finais com o dataset base (student_info)</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>exam_info_tbl &lt;-<span class="st"> </span>student_info <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="st">  </span><span class="kw">left_join</span>(final_score_exam_tbl, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;code_module&quot;</span>, <span class="st">&quot;code_presentation&quot;</span>, <span class="st">&quot;id_student&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>final_result.y) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">final_result =</span> final_result.x) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="st">  </span><span class="kw">drop_na</span>(final_score_exam)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">kbl</span>(exam_info_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()) <span class="op">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="st">  </span><span class="kw">kable_paper</span>(<span class="st">&quot;striped&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="st">  </span><span class="kw">scroll_box</span>(<span class="dt">width =</span> <span class="st">&quot;100%&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class=" lightable-paper lightable-striped" style="font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
code_module
</th>
<th style="text-align:left;">
code_presentation
</th>
<th style="text-align:right;">
id_student
</th>
<th style="text-align:left;">
gender
</th>
<th style="text-align:left;">
region
</th>
<th style="text-align:left;">
highest_education
</th>
<th style="text-align:left;">
imd_band
</th>
<th style="text-align:left;">
age_band
</th>
<th style="text-align:right;">
num_of_prev_attempts
</th>
<th style="text-align:right;">
studied_credits
</th>
<th style="text-align:left;">
disability
</th>
<th style="text-align:left;">
final_result
</th>
<th style="text-align:right;">
final_score_exam
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
29764
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
East Anglian Region
</td>
<td style="text-align:left;">
A Level or Equivalent
</td>
<td style="text-align:left;">
50-60%
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Distinction
</td>
<td style="text-align:right;">
94
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
29820
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
East Anglian Region
</td>
<td style="text-align:left;">
HE Qualification
</td>
<td style="text-align:left;">
40-50%
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
76
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
40604
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
Ireland
</td>
<td style="text-align:left;">
A Level or Equivalent
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
35-55
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
30
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
66
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
42638
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
Scotland
</td>
<td style="text-align:left;">
HE Qualification
</td>
<td style="text-align:left;">
90-100%
</td>
<td style="text-align:left;">
35-55
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
50
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
46605
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
East Anglian Region
</td>
<td style="text-align:left;">
HE Qualification
</td>
<td style="text-align:left;">
60-70%
</td>
<td style="text-align:left;">
35-55
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
60
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Distinction
</td>
<td style="text-align:right;">
98
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
49119
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
Ireland
</td>
<td style="text-align:left;">
HE Qualification
</td>
<td style="text-align:left;">
NA
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
90
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Distinction
</td>
<td style="text-align:right;">
100
</td>
</tr>
</tbody>
</table>
</div>
<p>Algumas variáveis não fazem sentido serem adicionadas para treino do modelo, pois não são informações previamente disponíveis para cada estudante, ou seja, elas aconteceram apenas no futuro e portanto não tem como serem usadas como preditoras. Por conta disso, iremos dropar algumas features.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>exam_info_v2_tbl &lt;-<span class="st"> </span>exam_info_tbl <span class="op">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>studied_credits, <span class="op">-</span>final_result)</span></code></pre></div>
<p>Meu intuito inicial era realizar a previsão do desempenho por curso, porém, como temos poucos dados fica inviável tal abordagem.</p>
<p>Como nosso dataset é predominantemente categórico, é super interessante observar como está a distribuição das diferentes classes. Para isso eu criei uma função que nos permite visualizar todas as features com apenas um comando.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>plot_all_full_data &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="st">&quot;region&quot;</span>) {</span>
<span id="cb7-2"><a href="#cb7-2"></a>  </span>
<span id="cb7-3"><a href="#cb7-3"></a>  exam_info_v2_tbl <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="st">    </span><span class="kw">count</span>(.data[[name]]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n<span class="op">/</span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">fct_reorder</span>(.data[[name]], prop),</span>
<span id="cb7-7"><a href="#cb7-7"></a>               <span class="dt">x =</span> prop)) <span class="op">+</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="st">    </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">xend =</span> <span class="dv">0</span>, <span class="dt">yend =</span> .data[[name]]),</span>
<span id="cb7-9"><a href="#cb7-9"></a>                 <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">size =</span> prop),</span>
<span id="cb7-11"><a href="#cb7-11"></a>               <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="st">    </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">label =</span> prop <span class="op">%&gt;%</span><span class="st"> </span>scales<span class="op">::</span><span class="kw">number</span>(<span class="dt">accuracy =</span> <span class="fl">.01</span>), <span class="dt">size =</span> prop<span class="op">*</span><span class="dv">50</span>), </span>
<span id="cb7-13"><a href="#cb7-13"></a>               <span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>, </span>
<span id="cb7-14"><a href="#cb7-14"></a>               <span class="dt">hjust =</span> <span class="st">&quot;inward&quot;</span>,</span>
<span id="cb7-15"><a href="#cb7-15"></a>               <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="st">    </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="st">    </span><span class="kw">labs</span>(</span>
<span id="cb7-18"><a href="#cb7-18"></a>      <span class="dt">y =</span> name</span>
<span id="cb7-19"><a href="#cb7-19"></a>    )</span>
<span id="cb7-20"><a href="#cb7-20"></a>}</span>
<span id="cb7-21"><a href="#cb7-21"></a></span>
<span id="cb7-22"><a href="#cb7-22"></a>names &lt;-<span class="st"> </span><span class="kw">names</span>(exam_info_v2_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">where</span>(is.character)))</span>
<span id="cb7-23"><a href="#cb7-23"></a>all_plots &lt;-<span class="st"> </span><span class="kw">map</span>(names, <span class="dt">.f =</span> plot_all_full_data)</span>
<span id="cb7-24"><a href="#cb7-24"></a>cowplot<span class="op">::</span><span class="kw">plot_grid</span>(<span class="dt">plotlist =</span> all_plots)</span></code></pre></div>
<p><img src="etapa2_3_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>Vimos aqui que algumas classes são bem desiquilibradas e isso pode ser um problema para nossa previsão. Por enquanto seguiremos desta forma para criação de um modelo baseline.</p>
<p>Além disso, a variável <code>imd_band</code> possui alguns valores missing. Por enquanto a mesma não será considerada.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>exam_info_final_tbl &lt;-<span class="st"> </span>exam_info_v2_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>imd_band)</span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">kbl</span>(exam_info_final_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()) <span class="op">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="st">  </span><span class="kw">kable_paper</span>(<span class="st">&quot;striped&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="st">  </span><span class="kw">scroll_box</span>(<span class="dt">width =</span> <span class="st">&quot;100%&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class=" lightable-paper lightable-striped" style="font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
code_module
</th>
<th style="text-align:left;">
code_presentation
</th>
<th style="text-align:right;">
id_student
</th>
<th style="text-align:left;">
gender
</th>
<th style="text-align:left;">
region
</th>
<th style="text-align:left;">
highest_education
</th>
<th style="text-align:left;">
age_band
</th>
<th style="text-align:right;">
num_of_prev_attempts
</th>
<th style="text-align:left;">
disability
</th>
<th style="text-align:right;">
final_score_exam
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
29764
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
East Anglian Region
</td>
<td style="text-align:left;">
A Level or Equivalent
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:right;">
94
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
29820
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
East Anglian Region
</td>
<td style="text-align:left;">
HE Qualification
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:right;">
76
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
40604
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
Ireland
</td>
<td style="text-align:left;">
A Level or Equivalent
</td>
<td style="text-align:left;">
35-55
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:right;">
66
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
42638
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
Scotland
</td>
<td style="text-align:left;">
HE Qualification
</td>
<td style="text-align:left;">
35-55
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:right;">
50
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
46605
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
East Anglian Region
</td>
<td style="text-align:left;">
HE Qualification
</td>
<td style="text-align:left;">
35-55
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:right;">
98
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
49119
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
Ireland
</td>
<td style="text-align:left;">
HE Qualification
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:right;">
100
</td>
</tr>
</tbody>
</table>
</div>
<p>Sendo assim, nosso dataset que será utilizado para as previsões é o <code>exam_info_final_tbl</code>.</p>
</div>
<div id="split-de-treino-e-teste" class="section level1">
<h1>Split de treino e teste</h1>
<p>Precisamos dividir nossos dados entre treino e teste. Um problema que pode ocorrer aqui é das classes ficarem com distribuições diferentes, ou ainda classes de pouca ocorrência ficarem fora de algum conjunto de dado. A função <code>initial_split()</code> possui uma forma de auxiliar nessa tarefa, o parâmetro <code>strata</code>, este serve para indicar qual variável irá manter a proporção de classes na hora do split.</p>
<p>Nesse caso eu optei pela variável <code>highest_education</code> por conter algumas classes com pouquísimos valores.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a>splits &lt;-<span class="st"> </span><span class="kw">initial_split</span>(<span class="dt">prop =</span> <span class="fl">.7</span>, <span class="dt">strata =</span> <span class="st">&quot;highest_education&quot;</span>, <span class="dt">data =</span> exam_info_final_tbl)</span>
<span id="cb9-3"><a href="#cb9-3"></a></span>
<span id="cb9-4"><a href="#cb9-4"></a>train &lt;-<span class="st"> </span><span class="kw">training</span>(splits)</span>
<span id="cb9-5"><a href="#cb9-5"></a>test &lt;-<span class="st"> </span><span class="kw">testing</span>(splits)</span></code></pre></div>
<p>Vamos checar novamente as distribuições.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>plot_all_full_train &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="st">&quot;region&quot;</span>) {</span>
<span id="cb10-2"><a href="#cb10-2"></a>  </span>
<span id="cb10-3"><a href="#cb10-3"></a>  train <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="st">    </span><span class="kw">count</span>(.data[[name]]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n<span class="op">/</span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">fct_reorder</span>(.data[[name]], prop),</span>
<span id="cb10-7"><a href="#cb10-7"></a>               <span class="dt">x =</span> prop)) <span class="op">+</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="st">    </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">xend =</span> <span class="dv">0</span>, <span class="dt">yend =</span> .data[[name]]),</span>
<span id="cb10-9"><a href="#cb10-9"></a>                 <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">size =</span> prop),</span>
<span id="cb10-11"><a href="#cb10-11"></a>               <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="st">    </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">label =</span> prop <span class="op">%&gt;%</span><span class="st"> </span>scales<span class="op">::</span><span class="kw">number</span>(<span class="dt">accuracy =</span> <span class="fl">.01</span>), <span class="dt">size =</span> prop<span class="op">*</span><span class="dv">50</span>), </span>
<span id="cb10-13"><a href="#cb10-13"></a>               <span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>, </span>
<span id="cb10-14"><a href="#cb10-14"></a>               <span class="dt">hjust =</span> <span class="st">&quot;inward&quot;</span>,</span>
<span id="cb10-15"><a href="#cb10-15"></a>               <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="st">    </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="st">    </span><span class="kw">labs</span>(</span>
<span id="cb10-18"><a href="#cb10-18"></a>      <span class="dt">y =</span> name</span>
<span id="cb10-19"><a href="#cb10-19"></a>    )</span>
<span id="cb10-20"><a href="#cb10-20"></a>}</span>
<span id="cb10-21"><a href="#cb10-21"></a></span>
<span id="cb10-22"><a href="#cb10-22"></a>names &lt;-<span class="st"> </span><span class="kw">names</span>(train <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">where</span>(is.character)))</span>
<span id="cb10-23"><a href="#cb10-23"></a>all_plots &lt;-<span class="st"> </span><span class="kw">map</span>(names, plot_all_full_train)</span>
<span id="cb10-24"><a href="#cb10-24"></a>cowplot<span class="op">::</span><span class="kw">plot_grid</span>(<span class="dt">plotlist =</span> all_plots)</span></code></pre></div>
<p><img src="etapa2_3_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>plot_all_full_test &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="st">&quot;region&quot;</span>) {</span>
<span id="cb11-2"><a href="#cb11-2"></a>  </span>
<span id="cb11-3"><a href="#cb11-3"></a>  test <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="st">    </span><span class="kw">count</span>(.data[[name]]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n<span class="op">/</span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">fct_reorder</span>(.data[[name]], prop),</span>
<span id="cb11-7"><a href="#cb11-7"></a>               <span class="dt">x =</span> prop)) <span class="op">+</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="st">    </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">xend =</span> <span class="dv">0</span>, <span class="dt">yend =</span> .data[[name]]),</span>
<span id="cb11-9"><a href="#cb11-9"></a>                 <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">size =</span> prop),</span>
<span id="cb11-11"><a href="#cb11-11"></a>               <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="st">    </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">label =</span> prop <span class="op">%&gt;%</span><span class="st"> </span>scales<span class="op">::</span><span class="kw">number</span>(<span class="dt">accuracy =</span> <span class="fl">.01</span>), <span class="dt">size =</span> prop<span class="op">*</span><span class="dv">50</span>), </span>
<span id="cb11-13"><a href="#cb11-13"></a>               <span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>, </span>
<span id="cb11-14"><a href="#cb11-14"></a>               <span class="dt">hjust =</span> <span class="st">&quot;inward&quot;</span>,</span>
<span id="cb11-15"><a href="#cb11-15"></a>               <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="st">    </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="st">    </span><span class="kw">labs</span>(</span>
<span id="cb11-18"><a href="#cb11-18"></a>      <span class="dt">y =</span> name</span>
<span id="cb11-19"><a href="#cb11-19"></a>    )</span>
<span id="cb11-20"><a href="#cb11-20"></a>}</span>
<span id="cb11-21"><a href="#cb11-21"></a></span>
<span id="cb11-22"><a href="#cb11-22"></a>names &lt;-<span class="st"> </span><span class="kw">names</span>(test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">where</span>(is.character)))</span>
<span id="cb11-23"><a href="#cb11-23"></a>all_plots &lt;-<span class="st"> </span><span class="kw">map</span>(names, plot_all_full_test)</span>
<span id="cb11-24"><a href="#cb11-24"></a>cowplot<span class="op">::</span><span class="kw">plot_grid</span>(<span class="dt">plotlist =</span> all_plots)</span></code></pre></div>
<p><img src="etapa2_3_files/figure-html/unnamed-chunk-8-2.png" width="672" /></p>
<p>Visualizamos que em ambos os casos as proporções foram mantidas, o que é importante para generalização do modelo.</p>
</div>
<div id="recipe" class="section level1">
<h1>Recipe</h1>
<p>As etapas de pré-processamento serão feitas utilizando o pacote <code>recipes</code>. Onde cada step é responsável por uma transformação.</p>
<p>Optei por utilizar o one hot encoder em praticamente todas as variáveis categóricas, com excessão da <code>age_band</code> que é uma variável ordinal e pode apenas ser utilizada como fator.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>recipe_spec &lt;-<span class="st"> </span><span class="kw">recipe</span>(final_score_exam <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="st">  </span><span class="kw">update_role</span>(code_module, code_presentation, id_student, <span class="dt">new_role =</span> <span class="st">&quot;indicator&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="st">  </span><span class="kw">step_string2factor</span>(age_band, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;0-35&quot;</span>, <span class="st">&quot;35-55&quot;</span>, <span class="st">&quot;55&lt;=&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="st">  </span><span class="kw">step_dummy</span>(<span class="kw">all_predictors</span>(), <span class="op">-</span>num_of_prev_attempts, <span class="op">-</span>age_band, <span class="dt">one_hot =</span> T)</span>
<span id="cb12-5"><a href="#cb12-5"></a></span>
<span id="cb12-6"><a href="#cb12-6"></a></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="kw">kbl</span>(recipe_spec <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">prep</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">juice</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()) <span class="op">%&gt;%</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="st">  </span><span class="kw">kable_paper</span>(<span class="st">&quot;striped&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="st">  </span><span class="kw">scroll_box</span>(<span class="dt">width =</span> <span class="st">&quot;100%&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class=" lightable-paper lightable-striped" style="font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
code_module
</th>
<th style="text-align:left;">
code_presentation
</th>
<th style="text-align:right;">
id_student
</th>
<th style="text-align:left;">
age_band
</th>
<th style="text-align:right;">
num_of_prev_attempts
</th>
<th style="text-align:right;">
final_score_exam
</th>
<th style="text-align:right;">
gender_F
</th>
<th style="text-align:right;">
gender_M
</th>
<th style="text-align:right;">
region_East.Anglian.Region
</th>
<th style="text-align:right;">
region_East.Midlands.Region
</th>
<th style="text-align:right;">
region_Ireland
</th>
<th style="text-align:right;">
region_London.Region
</th>
<th style="text-align:right;">
region_North.Region
</th>
<th style="text-align:right;">
region_North.Western.Region
</th>
<th style="text-align:right;">
region_Scotland
</th>
<th style="text-align:right;">
region_South.East.Region
</th>
<th style="text-align:right;">
region_South.Region
</th>
<th style="text-align:right;">
region_South.West.Region
</th>
<th style="text-align:right;">
region_Wales
</th>
<th style="text-align:right;">
region_West.Midlands.Region
</th>
<th style="text-align:right;">
region_Yorkshire.Region
</th>
<th style="text-align:right;">
highest_education_A.Level.or.Equivalent
</th>
<th style="text-align:right;">
highest_education_HE.Qualification
</th>
<th style="text-align:right;">
highest_education_Lower.Than.A.Level
</th>
<th style="text-align:right;">
highest_education_No.Formal.quals
</th>
<th style="text-align:right;">
highest_education_Post.Graduate.Qualification
</th>
<th style="text-align:right;">
disability_N
</th>
<th style="text-align:right;">
disability_Y
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
29764
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
94
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
29820
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
76
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
40604
</td>
<td style="text-align:left;">
35-55
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
66
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
42638
</td>
<td style="text-align:left;">
35-55
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
46605
</td>
<td style="text-align:left;">
35-55
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
98
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso C
</td>
<td style="text-align:left;">
2014B
</td>
<td style="text-align:right;">
57340
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
68
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
</div>
<p>Explicação dos steps:</p>
<ul>
<li><strong>update_role</strong>: cria uma especificação para algumas variáveis que não serão utilizadas como preditores mas terão um papel de identificação.</li>
<li><strong>step_string2factor</strong>: conversão de variáveis categóricas para fator</li>
<li><strong>step_dummy</strong>: aplicação do one-hot-encoding</li>
</ul>
</div>
<div id="model" class="section level1">
<h1>Model</h1>
<p>Na etapa anterior nós criamos especificações de pré-processamento, nessa nós criaremos especificações dos modelos.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># 1 - Random Forest</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>rf_spec &lt;-<span class="st"> </span><span class="kw">rand_forest</span>(<span class="dt">mode =</span> <span class="st">&quot;regression&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;ranger&quot;</span>)</span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co"># 2 - Linear Regression</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>lm_spec &lt;-<span class="st"> </span><span class="kw">linear_reg</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;lm&quot;</span>)</span></code></pre></div>
</div>
<div id="worflow" class="section level1">
<h1>Worflow</h1>
<p>No worflow você coloca tudo junto (modelo e receita).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># 1 - workflow random forest</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>wf_rf_spec &lt;-<span class="st"> </span><span class="kw">workflow</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="st">  </span><span class="kw">add_recipe</span>(recipe_spec) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="st">  </span><span class="kw">add_model</span>(rf_spec)</span>
<span id="cb14-5"><a href="#cb14-5"></a></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="co"># 2 - workflow linear regression</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>wf_lm_spec &lt;-<span class="st"> </span>wf_rf_spec <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">update_model</span>(lm_spec)</span>
<span id="cb14-8"><a href="#cb14-8"></a></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co"># objetos workflow</span></span>
<span id="cb14-10"><a href="#cb14-10"></a>wf_rf_spec</span></code></pre></div>
<pre><code>## ══ Workflow ═════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: rand_forest()
## 
## ── Preprocessor ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## 2 Recipe Steps
## 
## ● step_string2factor()
## ● step_dummy()
## 
## ── Model ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## Random Forest Model Specification (regression)
## 
## Computational engine: ranger</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>wf_lm_spec</span></code></pre></div>
<pre><code>## ══ Workflow ═════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: linear_reg()
## 
## ── Preprocessor ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## 2 Recipe Steps
## 
## ● step_string2factor()
## ● step_dummy()
## 
## ── Model ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
## Linear Regression Model Specification (regression)
## 
## Computational engine: lm</code></pre>
</div>
<div id="fit" class="section level1">
<h1>Fit</h1>
<p>No fit é onde de fato todas as especificações passadas são aplicadas e treinadas nos dados de treino.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>fitted_rf_wf &lt;-<span class="st"> </span>wf_rf_spec <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="st">  </span><span class="kw">fit</span>(<span class="dt">data =</span> train)</span>
<span id="cb18-3"><a href="#cb18-3"></a></span>
<span id="cb18-4"><a href="#cb18-4"></a>fitted_lm_wf &lt;-<span class="st"> </span>wf_lm_spec <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="st">  </span><span class="kw">fit</span>(<span class="dt">data =</span> train)</span></code></pre></div>
</div>
<div id="predict" class="section level1">
<h1>Predict</h1>
<p>Aqui vamos realizar as previsões e salvar os resultados dos dois modelos em uma nova tabela.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>results_treino &lt;-<span class="st"> </span>fitted_rf_wf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="st">  </span><span class="kw">predict</span>(<span class="dt">new_data =</span> train) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">valor_real =</span> train<span class="op">$</span>final_score_exam,</span>
<span id="cb19-4"><a href="#cb19-4"></a>         <span class="dt">model =</span> <span class="st">&quot;rf&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="st">  </span><span class="kw">bind_rows</span>(fitted_lm_wf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="st">              </span><span class="kw">predict</span>(<span class="dt">new_data =</span> train) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="st">              </span><span class="kw">mutate</span>(<span class="dt">valor_real =</span> train<span class="op">$</span>final_score_exam,</span>
<span id="cb19-8"><a href="#cb19-8"></a>                     <span class="dt">model =</span> <span class="st">&quot;lm&quot;</span>))</span></code></pre></div>
<pre><code>## Warning in predict.lm(object = object$fit, newdata = new_data, type = &quot;response&quot;): prediction from a rank-deficient fit may be misleading</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>results_test &lt;-<span class="st"> </span>fitted_rf_wf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="st">  </span><span class="kw">predict</span>(<span class="dt">new_data =</span> test) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">valor_real =</span> test<span class="op">$</span>final_score_exam,</span>
<span id="cb21-4"><a href="#cb21-4"></a>         <span class="dt">model =</span> <span class="st">&quot;rf&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="st">  </span><span class="kw">bind_rows</span>(fitted_lm_wf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="st">              </span><span class="kw">predict</span>(<span class="dt">new_data =</span> test) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="st">              </span><span class="kw">mutate</span>(<span class="dt">valor_real =</span> test<span class="op">$</span>final_score_exam,</span>
<span id="cb21-8"><a href="#cb21-8"></a>                     <span class="dt">model =</span> <span class="st">&quot;lm&quot;</span>))</span></code></pre></div>
<pre><code>## Warning in predict.lm(object = object$fit, newdata = new_data, type = &quot;response&quot;): prediction from a rank-deficient fit may be misleading</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>results_test <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="st">  </span><span class="kw">group_by</span>(model) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="st">  </span><span class="kw">rmse</span>(valor_real, .pred)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 4
##   model .metric .estimator .estimate
##   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 lm    rmse    standard        19.9
## 2 rf    rmse    standard        20.0</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>results_treino <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="st">  </span><span class="kw">group_by</span>(model) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="st">  </span><span class="kw">rmse</span>(valor_real, .pred)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 4
##   model .metric .estimator .estimate
##   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 lm    rmse    standard        19.8
## 2 rf    rmse    standard        19.0</code></pre>
<p>Vemos que os dois modelos possuem valores bem próximos do RMSE, quase 19.8 e 19.9. Podemos então visualizar o resultado dos valores preditos vs valores reais.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>results_test <span class="op">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="st">  </span><span class="co">#filter(model == &quot;rf&quot;) %&gt;% </span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">task =</span> <span class="st">&quot;Testing&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="st">  </span><span class="kw">bind_rows</span>(results_treino <span class="op">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="st">              </span><span class="kw">mutate</span>(<span class="dt">task =</span> <span class="st">&quot;Training&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(valor_real, .pred, <span class="dt">color =</span> model)) <span class="op">+</span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="st">  </span><span class="kw">geom_abline</span>(<span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">color =</span> <span class="st">&quot;gray80&quot;</span>, <span class="dt">size =</span> <span class="fl">1.5</span>) <span class="op">+</span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#012623&quot;</span>, <span class="st">&quot;#04BF68&quot;</span>)) <span class="op">+</span></span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>task) <span class="op">+</span></span>
<span id="cb27-11"><a href="#cb27-11"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb27-12"><a href="#cb27-12"></a>    <span class="dt">x =</span> <span class="st">&quot;Valor Real&quot;</span>,</span>
<span id="cb27-13"><a href="#cb27-13"></a>    <span class="dt">y =</span> <span class="st">&quot;Performance Predita&quot;</span>,</span>
<span id="cb27-14"><a href="#cb27-14"></a>    <span class="dt">color =</span> <span class="st">&quot;Tipo de modelo&quot;</span>,</span>
<span id="cb27-15"><a href="#cb27-15"></a>    <span class="dt">title =</span> <span class="st">&quot;Valores reais vs valores observados nas previsões&quot;</span></span>
<span id="cb27-16"><a href="#cb27-16"></a>  ) <span class="op">+</span></span>
<span id="cb27-17"><a href="#cb27-17"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
<p><img src="etapa2_3_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>Pelo gráfico dos resíduos vemos que os dois modelos tiveram resultados bem próximos, tanto nos dados de treino quanto nos dados de teste. O ideal formato desse gráfico é que os pontos estejam o mais próximo possível de uma linha reta, porém nossos resultados não foram muito bons, ainda existe muita variância para ser explicada pelo modelo.</p>
<p>Podemos aplicar uma técnica de resampling para investigar como o modelo se comporta em diferentes dados de validação.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># apenas nos dados de treino</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="co"># mantendo a proporção do split inicial</span></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb28-4"><a href="#cb28-4"></a>score_folds &lt;-<span class="st"> </span><span class="kw">vfold_cv</span>(train, <span class="dt">strata =</span> <span class="st">&quot;highest_education&quot;</span>, <span class="dt">v =</span> <span class="dv">5</span>)</span>
<span id="cb28-5"><a href="#cb28-5"></a></span>
<span id="cb28-6"><a href="#cb28-6"></a>rf_res &lt;-<span class="st"> </span><span class="kw">fit_resamples</span>(</span>
<span id="cb28-7"><a href="#cb28-7"></a>  wf_rf_spec,</span>
<span id="cb28-8"><a href="#cb28-8"></a>  score_folds,</span>
<span id="cb28-9"><a href="#cb28-9"></a>  <span class="dt">control =</span> <span class="kw">control_resamples</span>(<span class="dt">save_pred =</span> <span class="ot">TRUE</span>, <span class="dt">verbose =</span> T)</span>
<span id="cb28-10"><a href="#cb28-10"></a>)</span></code></pre></div>
<pre><code>## i Fold1: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold1: preprocessor 1/1</code></pre>
<pre><code>## i Fold1: preprocessor 1/1, model 1/1</code></pre>
<pre><code>## ✓ Fold1: preprocessor 1/1, model 1/1</code></pre>
<pre><code>## i Fold1: preprocessor 1/1, model 1/1 (predictions)</code></pre>
<pre><code>## i Fold2: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold2: preprocessor 1/1</code></pre>
<pre><code>## i Fold2: preprocessor 1/1, model 1/1</code></pre>
<pre><code>## ✓ Fold2: preprocessor 1/1, model 1/1</code></pre>
<pre><code>## i Fold2: preprocessor 1/1, model 1/1 (predictions)</code></pre>
<pre><code>## i Fold3: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold3: preprocessor 1/1</code></pre>
<pre><code>## i Fold3: preprocessor 1/1, model 1/1</code></pre>
<pre><code>## ✓ Fold3: preprocessor 1/1, model 1/1</code></pre>
<pre><code>## i Fold3: preprocessor 1/1, model 1/1 (predictions)</code></pre>
<pre><code>## i Fold4: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold4: preprocessor 1/1</code></pre>
<pre><code>## i Fold4: preprocessor 1/1, model 1/1</code></pre>
<pre><code>## ✓ Fold4: preprocessor 1/1, model 1/1</code></pre>
<pre><code>## i Fold4: preprocessor 1/1, model 1/1 (predictions)</code></pre>
<pre><code>## i Fold5: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold5: preprocessor 1/1</code></pre>
<pre><code>## i Fold5: preprocessor 1/1, model 1/1</code></pre>
<pre><code>## ✓ Fold5: preprocessor 1/1, model 1/1</code></pre>
<pre><code>## i Fold5: preprocessor 1/1, model 1/1 (predictions)</code></pre>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>rf_res <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb54-2"><a href="#cb54-2"></a><span class="st">  </span><span class="kw">collect_metrics</span>()</span></code></pre></div>
<pre><code>## # A tibble: 2 x 6
##   .metric .estimator    mean     n std_err .config             
##   &lt;chr&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
## 1 rmse    standard   20.0        5 0.214   Preprocessor1_Model1
## 2 rsq     standard    0.0552     5 0.00896 Preprocessor1_Model1</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="co"># melhor modelo</span></span>
<span id="cb56-2"><a href="#cb56-2"></a>rf_res <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb56-3"><a href="#cb56-3"></a><span class="st">  </span><span class="kw">show_best</span>(<span class="dt">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 6
##   .metric .estimator  mean     n std_err .config             
##   &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
## 1 rmse    standard    20.0     5   0.214 Preprocessor1_Model1</code></pre>
<p>O melhor RMSE considerando a média dos 5 conjuntos de dados de validação foi de 20.1, o que é um valor um pouco maior do que quando considerado apenas os dados de treino. A explicação é que na técnica de resampling você acaba reduzindo ainda mais os dados para ser possível treinar em uma parte e investigar a performance em outra, e como os dados já eram poucos fica mais difícil de capturar algum padrão nos dados.</p>
</div>
<div id="tunning" class="section level1">
<h1>tunning</h1>
<p>O Random Forest é um algorítmo que possui alguns parâmetros que podem ser otimizados em cada resample no intuito de otimizar alguma métrica, essa técnica é conhecida como tunning dos parâmetros.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a><span class="co"># aumentando os folds para 10</span></span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb58-3"><a href="#cb58-3"></a>score_folds &lt;-<span class="st"> </span><span class="kw">vfold_cv</span>(train, <span class="dt">strata =</span> <span class="st">&quot;highest_education&quot;</span>, <span class="dt">v =</span> <span class="dv">10</span>)</span>
<span id="cb58-4"><a href="#cb58-4"></a></span>
<span id="cb58-5"><a href="#cb58-5"></a><span class="co"># tunning</span></span>
<span id="cb58-6"><a href="#cb58-6"></a>model_spec_rf_tune &lt;-<span class="st"> </span><span class="kw">rand_forest</span>(</span>
<span id="cb58-7"><a href="#cb58-7"></a>    <span class="dt">mode    =</span> <span class="st">&quot;regression&quot;</span>,</span>
<span id="cb58-8"><a href="#cb58-8"></a>    <span class="dt">mtry    =</span> <span class="kw">tune</span>(),</span>
<span id="cb58-9"><a href="#cb58-9"></a>    <span class="dt">trees   =</span> <span class="kw">tune</span>(),</span>
<span id="cb58-10"><a href="#cb58-10"></a>    <span class="dt">min_n   =</span> <span class="kw">tune</span>()</span>
<span id="cb58-11"><a href="#cb58-11"></a>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb58-12"><a href="#cb58-12"></a><span class="st">    </span><span class="kw">set_engine</span>(<span class="st">&quot;ranger&quot;</span>)</span>
<span id="cb58-13"><a href="#cb58-13"></a></span>
<span id="cb58-14"><a href="#cb58-14"></a></span>
<span id="cb58-15"><a href="#cb58-15"></a>wflw_spec_rf_tune &lt;-<span class="st"> </span><span class="kw">workflow</span>() <span class="op">%&gt;%</span></span>
<span id="cb58-16"><a href="#cb58-16"></a><span class="st">    </span><span class="kw">add_model</span>(model_spec_rf_tune) <span class="op">%&gt;%</span></span>
<span id="cb58-17"><a href="#cb58-17"></a><span class="st">    </span><span class="kw">add_recipe</span>(recipe_spec)</span>
<span id="cb58-18"><a href="#cb58-18"></a></span>
<span id="cb58-19"><a href="#cb58-19"></a><span class="co"># tuning</span></span>
<span id="cb58-20"><a href="#cb58-20"></a><span class="kw">library</span>(tictoc)</span>
<span id="cb58-21"><a href="#cb58-21"></a><span class="kw">tic</span>()</span>
<span id="cb58-22"><a href="#cb58-22"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb58-23"><a href="#cb58-23"></a>tune_results_rf &lt;-<span class="st"> </span>wflw_spec_rf_tune <span class="op">%&gt;%</span></span>
<span id="cb58-24"><a href="#cb58-24"></a><span class="st">    </span><span class="kw">tune_grid</span>(</span>
<span id="cb58-25"><a href="#cb58-25"></a>        <span class="dt">resamples =</span> score_folds,</span>
<span id="cb58-26"><a href="#cb58-26"></a>        <span class="dt">grid      =</span> <span class="dv">5</span>,</span>
<span id="cb58-27"><a href="#cb58-27"></a>        <span class="dt">control   =</span> <span class="kw">control_grid</span>(<span class="dt">verbose =</span> <span class="ot">TRUE</span>, <span class="dt">allow_par =</span> <span class="ot">TRUE</span>)</span>
<span id="cb58-28"><a href="#cb58-28"></a>    )</span></code></pre></div>
<pre><code>## i Creating pre-processing data to finalize unknown parameter: mtry</code></pre>
<pre><code>## i Fold01: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold01: preprocessor 1/1</code></pre>
<pre><code>## i Fold01: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## ✓ Fold01: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## i Fold01: preprocessor 1/1, model 1/5 (predictions)</code></pre>
<pre><code>## i Fold01: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## ✓ Fold01: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## i Fold01: preprocessor 1/1, model 2/5 (predictions)</code></pre>
<pre><code>## i Fold01: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## ✓ Fold01: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## i Fold01: preprocessor 1/1, model 3/5 (predictions)</code></pre>
<pre><code>## i Fold01: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## ✓ Fold01: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## i Fold01: preprocessor 1/1, model 4/5 (predictions)</code></pre>
<pre><code>## i Fold01: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## ✓ Fold01: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## i Fold01: preprocessor 1/1, model 5/5 (predictions)</code></pre>
<pre><code>## i Fold02: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold02: preprocessor 1/1</code></pre>
<pre><code>## i Fold02: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## ✓ Fold02: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## i Fold02: preprocessor 1/1, model 1/5 (predictions)</code></pre>
<pre><code>## i Fold02: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## ✓ Fold02: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## i Fold02: preprocessor 1/1, model 2/5 (predictions)</code></pre>
<pre><code>## i Fold02: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## ✓ Fold02: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## i Fold02: preprocessor 1/1, model 3/5 (predictions)</code></pre>
<pre><code>## i Fold02: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## ✓ Fold02: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## i Fold02: preprocessor 1/1, model 4/5 (predictions)</code></pre>
<pre><code>## i Fold02: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## ✓ Fold02: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## i Fold02: preprocessor 1/1, model 5/5 (predictions)</code></pre>
<pre><code>## i Fold03: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold03: preprocessor 1/1</code></pre>
<pre><code>## i Fold03: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## ✓ Fold03: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## i Fold03: preprocessor 1/1, model 1/5 (predictions)</code></pre>
<pre><code>## i Fold03: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## ✓ Fold03: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## i Fold03: preprocessor 1/1, model 2/5 (predictions)</code></pre>
<pre><code>## i Fold03: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## ✓ Fold03: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## i Fold03: preprocessor 1/1, model 3/5 (predictions)</code></pre>
<pre><code>## i Fold03: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## ✓ Fold03: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## i Fold03: preprocessor 1/1, model 4/5 (predictions)</code></pre>
<pre><code>## i Fold03: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## ✓ Fold03: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## i Fold03: preprocessor 1/1, model 5/5 (predictions)</code></pre>
<pre><code>## i Fold04: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold04: preprocessor 1/1</code></pre>
<pre><code>## i Fold04: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## ✓ Fold04: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## i Fold04: preprocessor 1/1, model 1/5 (predictions)</code></pre>
<pre><code>## i Fold04: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## ✓ Fold04: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## i Fold04: preprocessor 1/1, model 2/5 (predictions)</code></pre>
<pre><code>## i Fold04: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## ✓ Fold04: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## i Fold04: preprocessor 1/1, model 3/5 (predictions)</code></pre>
<pre><code>## i Fold04: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## ✓ Fold04: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## i Fold04: preprocessor 1/1, model 4/5 (predictions)</code></pre>
<pre><code>## i Fold04: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## ✓ Fold04: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## i Fold04: preprocessor 1/1, model 5/5 (predictions)</code></pre>
<pre><code>## i Fold05: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold05: preprocessor 1/1</code></pre>
<pre><code>## i Fold05: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## ✓ Fold05: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## i Fold05: preprocessor 1/1, model 1/5 (predictions)</code></pre>
<pre><code>## i Fold05: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## ✓ Fold05: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## i Fold05: preprocessor 1/1, model 2/5 (predictions)</code></pre>
<pre><code>## i Fold05: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## ✓ Fold05: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## i Fold05: preprocessor 1/1, model 3/5 (predictions)</code></pre>
<pre><code>## i Fold05: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## ✓ Fold05: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## i Fold05: preprocessor 1/1, model 4/5 (predictions)</code></pre>
<pre><code>## i Fold05: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## ✓ Fold05: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## i Fold05: preprocessor 1/1, model 5/5 (predictions)</code></pre>
<pre><code>## i Fold06: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold06: preprocessor 1/1</code></pre>
<pre><code>## i Fold06: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## ✓ Fold06: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## i Fold06: preprocessor 1/1, model 1/5 (predictions)</code></pre>
<pre><code>## i Fold06: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## ✓ Fold06: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## i Fold06: preprocessor 1/1, model 2/5 (predictions)</code></pre>
<pre><code>## i Fold06: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## ✓ Fold06: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## i Fold06: preprocessor 1/1, model 3/5 (predictions)</code></pre>
<pre><code>## i Fold06: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## ✓ Fold06: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## i Fold06: preprocessor 1/1, model 4/5 (predictions)</code></pre>
<pre><code>## i Fold06: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## ✓ Fold06: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## i Fold06: preprocessor 1/1, model 5/5 (predictions)</code></pre>
<pre><code>## i Fold07: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold07: preprocessor 1/1</code></pre>
<pre><code>## i Fold07: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## ✓ Fold07: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## i Fold07: preprocessor 1/1, model 1/5 (predictions)</code></pre>
<pre><code>## i Fold07: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## ✓ Fold07: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## i Fold07: preprocessor 1/1, model 2/5 (predictions)</code></pre>
<pre><code>## i Fold07: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## ✓ Fold07: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## i Fold07: preprocessor 1/1, model 3/5 (predictions)</code></pre>
<pre><code>## i Fold07: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## ✓ Fold07: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## i Fold07: preprocessor 1/1, model 4/5 (predictions)</code></pre>
<pre><code>## i Fold07: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## ✓ Fold07: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## i Fold07: preprocessor 1/1, model 5/5 (predictions)</code></pre>
<pre><code>## i Fold08: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold08: preprocessor 1/1</code></pre>
<pre><code>## i Fold08: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## ✓ Fold08: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## i Fold08: preprocessor 1/1, model 1/5 (predictions)</code></pre>
<pre><code>## i Fold08: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## ✓ Fold08: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## i Fold08: preprocessor 1/1, model 2/5 (predictions)</code></pre>
<pre><code>## i Fold08: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## ✓ Fold08: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## i Fold08: preprocessor 1/1, model 3/5 (predictions)</code></pre>
<pre><code>## i Fold08: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## ✓ Fold08: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## i Fold08: preprocessor 1/1, model 4/5 (predictions)</code></pre>
<pre><code>## i Fold08: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## ✓ Fold08: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## i Fold08: preprocessor 1/1, model 5/5 (predictions)</code></pre>
<pre><code>## i Fold09: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold09: preprocessor 1/1</code></pre>
<pre><code>## i Fold09: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## ✓ Fold09: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## i Fold09: preprocessor 1/1, model 1/5 (predictions)</code></pre>
<pre><code>## i Fold09: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## ✓ Fold09: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## i Fold09: preprocessor 1/1, model 2/5 (predictions)</code></pre>
<pre><code>## i Fold09: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## ✓ Fold09: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## i Fold09: preprocessor 1/1, model 3/5 (predictions)</code></pre>
<pre><code>## i Fold09: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## ✓ Fold09: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## i Fold09: preprocessor 1/1, model 4/5 (predictions)</code></pre>
<pre><code>## i Fold09: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## ✓ Fold09: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## i Fold09: preprocessor 1/1, model 5/5 (predictions)</code></pre>
<pre><code>## i Fold10: preprocessor 1/1</code></pre>
<pre><code>## ✓ Fold10: preprocessor 1/1</code></pre>
<pre><code>## i Fold10: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## ✓ Fold10: preprocessor 1/1, model 1/5</code></pre>
<pre><code>## i Fold10: preprocessor 1/1, model 1/5 (predictions)</code></pre>
<pre><code>## i Fold10: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## ✓ Fold10: preprocessor 1/1, model 2/5</code></pre>
<pre><code>## i Fold10: preprocessor 1/1, model 2/5 (predictions)</code></pre>
<pre><code>## i Fold10: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## ✓ Fold10: preprocessor 1/1, model 3/5</code></pre>
<pre><code>## i Fold10: preprocessor 1/1, model 3/5 (predictions)</code></pre>
<pre><code>## i Fold10: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## ✓ Fold10: preprocessor 1/1, model 4/5</code></pre>
<pre><code>## i Fold10: preprocessor 1/1, model 4/5 (predictions)</code></pre>
<pre><code>## i Fold10: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## ✓ Fold10: preprocessor 1/1, model 5/5</code></pre>
<pre><code>## i Fold10: preprocessor 1/1, model 5/5 (predictions)</code></pre>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1"></a><span class="kw">toc</span>()</span></code></pre></div>
<pre><code>## 158.663 sec elapsed</code></pre>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1"></a><span class="kw">kbl</span>(tune_results_rf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">show_best</span>(<span class="dt">metric =</span> <span class="st">&quot;rmse&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb232-2"><a href="#cb232-2"></a><span class="st">  </span><span class="kw">kable_paper</span>(<span class="st">&quot;striped&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb232-3"><a href="#cb232-3"></a><span class="st">  </span><span class="kw">scroll_box</span>(<span class="dt">width =</span> <span class="st">&quot;100%&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class=" lightable-paper lightable-striped" style="font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
mtry
</th>
<th style="text-align:right;">
trees
</th>
<th style="text-align:right;">
min_n
</th>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimator
</th>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
n
</th>
<th style="text-align:right;">
std_err
</th>
<th style="text-align:left;">
.config
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
217
</td>
<td style="text-align:right;">
37
</td>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
20.18555
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.1897398
</td>
<td style="text-align:left;">
Preprocessor1_Model4
</td>
</tr>
<tr>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
1845
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
20.20075
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.2101286
</td>
<td style="text-align:left;">
Preprocessor1_Model1
</td>
</tr>
<tr>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
1498
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
20.32148
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.2113791
</td>
<td style="text-align:left;">
Preprocessor1_Model5
</td>
</tr>
<tr>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
863
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
20.34463
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.2131936
</td>
<td style="text-align:left;">
Preprocessor1_Model2
</td>
</tr>
<tr>
<td style="text-align:right;">
16
</td>
<td style="text-align:right;">
728
</td>
<td style="text-align:right;">
15
</td>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
20.37381
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0.2143810
</td>
<td style="text-align:left;">
Preprocessor1_Model3
</td>
</tr>
</tbody>
</table>
</div>
<p>Acabamos aumentando os valores do RMSE. Ao final, nosso melhor modelo performou muito ruim, explicando minimamente a variância presente nos dados e com RMSE de aproximadamente 20. Realmente acredito que não tem muito a ser feito nesse modelo de regressão, pois precisamos de mais dados e mais variáveis.</p>
<p>Uma alternativa que proponho é a avaliação da performance dos estudantes utilizando um modelo de classificação e a variável de <code>final_result</code> para prever a probabilidade do estudante ser aprovado ou não.</p>
</div>
<div id="classification" class="section level1">
<h1>Classification</h1>
<p>Vamos ver então como se sai o modelo de classificação. Para isso, vamos precisar fazer alguns ajustes nos dados, veja o código abaixo.</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1"></a>student_final_result_tbl &lt;-<span class="st"> </span>student_info <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb233-2"><a href="#cb233-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="kw">across</span>(<span class="kw">where</span>(is.character), as_factor)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb233-3"><a href="#cb233-3"></a><span class="st">  </span><span class="kw">drop_na</span>(imd_band) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb233-4"><a href="#cb233-4"></a><span class="st">  </span><span class="co"># ordem correta dos fatores</span></span>
<span id="cb233-5"><a href="#cb233-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imd_band =</span> <span class="kw">fct_rev</span>(imd_band),</span>
<span id="cb233-6"><a href="#cb233-6"></a>         <span class="dt">age_band =</span> <span class="kw">fct_rev</span>(age_band)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb233-7"><a href="#cb233-7"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>studied_credits) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb233-8"><a href="#cb233-8"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imd_band =</span> <span class="kw">as.ordered</span>(imd_band))</span>
<span id="cb233-9"><a href="#cb233-9"></a></span>
<span id="cb233-10"><a href="#cb233-10"></a><span class="co"># visualizando as proporções depois do tratamento</span></span>
<span id="cb233-11"><a href="#cb233-11"></a>plot_all_full_trans &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="st">&quot;region&quot;</span>) {</span>
<span id="cb233-12"><a href="#cb233-12"></a>  </span>
<span id="cb233-13"><a href="#cb233-13"></a>  student_final_result_tbl <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb233-14"><a href="#cb233-14"></a><span class="st">    </span><span class="kw">count</span>(.data[[name]]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb233-15"><a href="#cb233-15"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n<span class="op">/</span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb233-16"><a href="#cb233-16"></a><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">fct_reorder</span>(.data[[name]], prop),</span>
<span id="cb233-17"><a href="#cb233-17"></a>               <span class="dt">x =</span> prop)) <span class="op">+</span></span>
<span id="cb233-18"><a href="#cb233-18"></a><span class="st">    </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">xend =</span> <span class="dv">0</span>, <span class="dt">yend =</span> .data[[name]]),</span>
<span id="cb233-19"><a href="#cb233-19"></a>                 <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb233-20"><a href="#cb233-20"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">size =</span> prop),</span>
<span id="cb233-21"><a href="#cb233-21"></a>               <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb233-22"><a href="#cb233-22"></a><span class="st">    </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">label =</span> prop <span class="op">%&gt;%</span><span class="st"> </span>scales<span class="op">::</span><span class="kw">number</span>(<span class="dt">accuracy =</span> <span class="fl">.01</span>), <span class="dt">size =</span> prop<span class="op">*</span><span class="dv">50</span>), </span>
<span id="cb233-23"><a href="#cb233-23"></a>               <span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>, </span>
<span id="cb233-24"><a href="#cb233-24"></a>               <span class="dt">hjust =</span> <span class="st">&quot;inward&quot;</span>,</span>
<span id="cb233-25"><a href="#cb233-25"></a>               <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb233-26"><a href="#cb233-26"></a><span class="st">    </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb233-27"><a href="#cb233-27"></a><span class="st">    </span><span class="kw">labs</span>(</span>
<span id="cb233-28"><a href="#cb233-28"></a>      <span class="dt">y =</span> name</span>
<span id="cb233-29"><a href="#cb233-29"></a>    )</span>
<span id="cb233-30"><a href="#cb233-30"></a>}</span>
<span id="cb233-31"><a href="#cb233-31"></a></span>
<span id="cb233-32"><a href="#cb233-32"></a>names &lt;-<span class="st"> </span><span class="kw">names</span>(student_final_result_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">where</span>(is.factor)))</span>
<span id="cb233-33"><a href="#cb233-33"></a>all_plots &lt;-<span class="st"> </span><span class="kw">map</span>(names, plot_all_full_trans)</span>
<span id="cb233-34"><a href="#cb233-34"></a>cowplot<span class="op">::</span><span class="kw">plot_grid</span>(<span class="dt">plotlist =</span> all_plots)</span></code></pre></div>
<p><img src="etapa2_3_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>Classes com valores muito baixos podem gerar problemas na hora das divisões entre treino e teste, por isso iremos agrupar algumas classes segundo descrição abaixo:</p>
<ul>
<li><strong>age_band</strong>: vai passar a ter duas variáveis categóricas, de 0 a 35 anos e acima de 35 anos.</li>
<li><strong>highest_education</strong>: vai passar a ter uma variável chamada “outros” oriunda da junção de <code>HE Qualification</code>, <code>No Formal quals</code> e <code>Post Graduate Qualification</code>.</li>
<li><strong>final_result</strong>: <code>Withdrawn</code> e <code>Fail</code> serão consideradas como <code>Fail</code> e <code>Distinction</code> e <code>Pass</code> como <code>Pass</code>.</li>
</ul>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="#cb234-1"></a>student_final_result_v2_tbl &lt;-<span class="st"> </span>student_final_result_tbl <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-2"><a href="#cb234-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age_band =</span> <span class="kw">as.character</span>(age_band)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-3"><a href="#cb234-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age_band =</span> <span class="kw">case_when</span>(</span>
<span id="cb234-4"><a href="#cb234-4"></a>    age_band <span class="op">==</span><span class="st"> &quot;55&lt;=&quot;</span> <span class="op">~</span><span class="st"> &quot;35-55&quot;</span>,</span>
<span id="cb234-5"><a href="#cb234-5"></a>    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>age_band</span>
<span id="cb234-6"><a href="#cb234-6"></a>  )) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-7"><a href="#cb234-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age_band =</span> <span class="kw">case_when</span>(</span>
<span id="cb234-8"><a href="#cb234-8"></a>    age_band <span class="op">==</span><span class="st"> &quot;35-55&quot;</span> <span class="op">~</span><span class="st"> &quot;35&lt;=&quot;</span>,</span>
<span id="cb234-9"><a href="#cb234-9"></a>    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>age_band</span>
<span id="cb234-10"><a href="#cb234-10"></a>  )) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-11"><a href="#cb234-11"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age_band =</span> <span class="kw">factor</span>(age_band, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;0-35&quot;</span>, <span class="st">&quot;35&lt;=&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-12"><a href="#cb234-12"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age_band =</span> <span class="kw">as.ordered</span>(age_band)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-13"><a href="#cb234-13"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">highest_education =</span> <span class="kw">fct_lump</span>(highest_education, <span class="dt">prop =</span> <span class="fl">0.2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-14"><a href="#cb234-14"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">highest_education =</span> <span class="kw">factor</span>(highest_education, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;Other&quot;</span>, <span class="st">&quot;Lower Than A Level&quot;</span>, <span class="st">&quot;A Level or Equivalent&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-15"><a href="#cb234-15"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">highest_education =</span> <span class="kw">as.ordered</span>(highest_education)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-16"><a href="#cb234-16"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">final_result =</span> final_result <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.character</span>()) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-17"><a href="#cb234-17"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">final_result =</span> <span class="kw">case_when</span>(</span>
<span id="cb234-18"><a href="#cb234-18"></a>    final_result <span class="op">==</span><span class="st"> &quot;Withdrawn&quot;</span> <span class="op">~</span><span class="st"> &quot;Fail&quot;</span>,</span>
<span id="cb234-19"><a href="#cb234-19"></a>    final_result <span class="op">==</span><span class="st"> &quot;Distinction&quot;</span> <span class="op">~</span><span class="st"> &quot;Pass&quot;</span>,</span>
<span id="cb234-20"><a href="#cb234-20"></a>    <span class="ot">TRUE</span> <span class="op">~</span><span class="st"> </span>final_result</span>
<span id="cb234-21"><a href="#cb234-21"></a>  )) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb234-22"><a href="#cb234-22"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">final_result =</span> <span class="kw">as.factor</span>(final_result))</span>
<span id="cb234-23"><a href="#cb234-23"></a></span>
<span id="cb234-24"><a href="#cb234-24"></a><span class="kw">kbl</span>(student_final_result_v2_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()) <span class="op">%&gt;%</span></span>
<span id="cb234-25"><a href="#cb234-25"></a><span class="st">  </span><span class="kw">kable_paper</span>(<span class="st">&quot;striped&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb234-26"><a href="#cb234-26"></a><span class="st">  </span><span class="kw">scroll_box</span>(<span class="dt">width =</span> <span class="st">&quot;100%&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class=" lightable-paper lightable-striped" style="font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
code_module
</th>
<th style="text-align:left;">
code_presentation
</th>
<th style="text-align:right;">
id_student
</th>
<th style="text-align:left;">
gender
</th>
<th style="text-align:left;">
region
</th>
<th style="text-align:left;">
highest_education
</th>
<th style="text-align:left;">
imd_band
</th>
<th style="text-align:left;">
age_band
</th>
<th style="text-align:right;">
num_of_prev_attempts
</th>
<th style="text-align:left;">
disability
</th>
<th style="text-align:left;">
final_result
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Curso A
</td>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
11391
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
East Anglian Region
</td>
<td style="text-align:left;">
Other
</td>
<td style="text-align:left;">
90-100%
</td>
<td style="text-align:left;">
35&lt;=
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Pass
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso A
</td>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
28400
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
Scotland
</td>
<td style="text-align:left;">
Other
</td>
<td style="text-align:left;">
20-30%
</td>
<td style="text-align:left;">
35&lt;=
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Pass
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso A
</td>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
30268
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
North Western Region
</td>
<td style="text-align:left;">
A Level or Equivalent
</td>
<td style="text-align:left;">
30-40%
</td>
<td style="text-align:left;">
35&lt;=
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Y
</td>
<td style="text-align:left;">
Fail
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso A
</td>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
31604
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
South East Region
</td>
<td style="text-align:left;">
A Level or Equivalent
</td>
<td style="text-align:left;">
50-60%
</td>
<td style="text-align:left;">
35&lt;=
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Pass
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso A
</td>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
32885
</td>
<td style="text-align:left;">
F
</td>
<td style="text-align:left;">
West Midlands Region
</td>
<td style="text-align:left;">
Lower Than A Level
</td>
<td style="text-align:left;">
50-60%
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Pass
</td>
</tr>
<tr>
<td style="text-align:left;">
Curso A
</td>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
38053
</td>
<td style="text-align:left;">
M
</td>
<td style="text-align:left;">
Wales
</td>
<td style="text-align:left;">
A Level or Equivalent
</td>
<td style="text-align:left;">
80-90%
</td>
<td style="text-align:left;">
35&lt;=
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
N
</td>
<td style="text-align:left;">
Pass
</td>
</tr>
</tbody>
</table>
</div>
<p>Vamos visualizar nossas variáveis categóricas mais uma vez antes da modelagem.</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1"></a><span class="co"># visualizando as proporções</span></span>
<span id="cb235-2"><a href="#cb235-2"></a>plot_all_full_prepro &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">name =</span> <span class="st">&quot;region&quot;</span>) {</span>
<span id="cb235-3"><a href="#cb235-3"></a>  </span>
<span id="cb235-4"><a href="#cb235-4"></a>  student_final_result_v2_tbl <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb235-5"><a href="#cb235-5"></a><span class="st">    </span><span class="kw">count</span>(.data[[name]]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb235-6"><a href="#cb235-6"></a><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">prop =</span> n<span class="op">/</span><span class="kw">sum</span>(n)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb235-7"><a href="#cb235-7"></a><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">fct_reorder</span>(.data[[name]], prop),</span>
<span id="cb235-8"><a href="#cb235-8"></a>               <span class="dt">x =</span> prop)) <span class="op">+</span></span>
<span id="cb235-9"><a href="#cb235-9"></a><span class="st">    </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">xend =</span> <span class="dv">0</span>, <span class="dt">yend =</span> .data[[name]]),</span>
<span id="cb235-10"><a href="#cb235-10"></a>                 <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb235-11"><a href="#cb235-11"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">size =</span> prop),</span>
<span id="cb235-12"><a href="#cb235-12"></a>               <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb235-13"><a href="#cb235-13"></a><span class="st">    </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">label =</span> prop <span class="op">%&gt;%</span><span class="st"> </span>scales<span class="op">::</span><span class="kw">number</span>(<span class="dt">accuracy =</span> <span class="fl">.01</span>), <span class="dt">size =</span> prop<span class="op">*</span><span class="dv">50</span>), </span>
<span id="cb235-14"><a href="#cb235-14"></a>               <span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>, </span>
<span id="cb235-15"><a href="#cb235-15"></a>               <span class="dt">hjust =</span> <span class="st">&quot;inward&quot;</span>,</span>
<span id="cb235-16"><a href="#cb235-16"></a>               <span class="dt">show.legend =</span> F) <span class="op">+</span></span>
<span id="cb235-17"><a href="#cb235-17"></a><span class="st">    </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb235-18"><a href="#cb235-18"></a><span class="st">    </span><span class="kw">labs</span>(</span>
<span id="cb235-19"><a href="#cb235-19"></a>      <span class="dt">y =</span> name</span>
<span id="cb235-20"><a href="#cb235-20"></a>    )</span>
<span id="cb235-21"><a href="#cb235-21"></a>}</span>
<span id="cb235-22"><a href="#cb235-22"></a></span>
<span id="cb235-23"><a href="#cb235-23"></a>names &lt;-<span class="st"> </span><span class="kw">names</span>(student_final_result_v2_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">where</span>(is.factor)))</span>
<span id="cb235-24"><a href="#cb235-24"></a>all_plots &lt;-<span class="st"> </span><span class="kw">map</span>(names, plot_all_full_prepro)</span>
<span id="cb235-25"><a href="#cb235-25"></a>cowplot<span class="op">::</span><span class="kw">plot_grid</span>(<span class="dt">plotlist =</span> all_plots)</span></code></pre></div>
<p><img src="etapa2_3_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>Pronto, nosso problema agora é uma classificação binomial e pronta modelagem. Vamos iniciar com os splits entre treino e teste.</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="#cb236-1"></a><span class="co"># split train and test</span></span>
<span id="cb236-2"><a href="#cb236-2"></a><span class="kw">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb236-3"><a href="#cb236-3"></a>splits &lt;-<span class="st"> </span><span class="kw">initial_split</span>(student_final_result_v2_tbl, <span class="dt">prop =</span> <span class="fl">.7</span>, <span class="dt">strata =</span> final_result)</span>
<span id="cb236-4"><a href="#cb236-4"></a></span>
<span id="cb236-5"><a href="#cb236-5"></a>train &lt;-<span class="st"> </span><span class="kw">training</span>(splits)</span>
<span id="cb236-6"><a href="#cb236-6"></a>test &lt;-<span class="st"> </span><span class="kw">testing</span>(splits)</span>
<span id="cb236-7"><a href="#cb236-7"></a></span>
<span id="cb236-8"><a href="#cb236-8"></a><span class="co"># recipe random forest</span></span>
<span id="cb236-9"><a href="#cb236-9"></a>recipe_class_rf_spec &lt;-<span class="st"> </span><span class="kw">recipe</span>(final_result <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb236-10"><a href="#cb236-10"></a><span class="st">  </span><span class="kw">update_role</span>(code_presentation, id_student, <span class="dt">new_role =</span> <span class="st">&quot;Identification&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb236-11"><a href="#cb236-11"></a><span class="st">  </span><span class="kw">step_dummy</span>(<span class="kw">all_predictors</span>(), <span class="op">-</span>num_of_prev_attempts, <span class="op">-</span>age_band, <span class="op">-</span>imd_band, <span class="op">-</span>highest_education)</span>
<span id="cb236-12"><a href="#cb236-12"></a></span>
<span id="cb236-13"><a href="#cb236-13"></a><span class="co"># dataset para o random forest  </span></span>
<span id="cb236-14"><a href="#cb236-14"></a><span class="kw">kbl</span>(recipe_class_rf_spec <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">prep</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">juice</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()) <span class="op">%&gt;%</span></span>
<span id="cb236-15"><a href="#cb236-15"></a><span class="st">  </span><span class="kw">kable_paper</span>(<span class="st">&quot;striped&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb236-16"><a href="#cb236-16"></a><span class="st">  </span><span class="kw">scroll_box</span>(<span class="dt">width =</span> <span class="st">&quot;100%&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class=" lightable-paper lightable-striped" style="font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
code_presentation
</th>
<th style="text-align:right;">
id_student
</th>
<th style="text-align:left;">
highest_education
</th>
<th style="text-align:left;">
imd_band
</th>
<th style="text-align:left;">
age_band
</th>
<th style="text-align:right;">
num_of_prev_attempts
</th>
<th style="text-align:left;">
final_result
</th>
<th style="text-align:right;">
code_module_Curso.B
</th>
<th style="text-align:right;">
code_module_Curso.C
</th>
<th style="text-align:right;">
code_module_Curso.D
</th>
<th style="text-align:right;">
code_module_Curso.E
</th>
<th style="text-align:right;">
code_module_Curso.F
</th>
<th style="text-align:right;">
code_module_Curso.G
</th>
<th style="text-align:right;">
gender_F
</th>
<th style="text-align:right;">
region_Scotland
</th>
<th style="text-align:right;">
region_North.Western.Region
</th>
<th style="text-align:right;">
region_South.East.Region
</th>
<th style="text-align:right;">
region_West.Midlands.Region
</th>
<th style="text-align:right;">
region_Wales
</th>
<th style="text-align:right;">
region_North.Region
</th>
<th style="text-align:right;">
region_South.Region
</th>
<th style="text-align:right;">
region_Ireland
</th>
<th style="text-align:right;">
region_South.West.Region
</th>
<th style="text-align:right;">
region_East.Midlands.Region
</th>
<th style="text-align:right;">
region_Yorkshire.Region
</th>
<th style="text-align:right;">
region_London.Region
</th>
<th style="text-align:right;">
disability_Y
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
28400
</td>
<td style="text-align:left;">
Other
</td>
<td style="text-align:left;">
20-30%
</td>
<td style="text-align:left;">
35&lt;=
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
30268
</td>
<td style="text-align:left;">
A Level or Equivalent
</td>
<td style="text-align:left;">
30-40%
</td>
<td style="text-align:left;">
35&lt;=
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Fail
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
31604
</td>
<td style="text-align:left;">
A Level or Equivalent
</td>
<td style="text-align:left;">
50-60%
</td>
<td style="text-align:left;">
35&lt;=
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
32885
</td>
<td style="text-align:left;">
Lower Than A Level
</td>
<td style="text-align:left;">
50-60%
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
38053
</td>
<td style="text-align:left;">
A Level or Equivalent
</td>
<td style="text-align:left;">
80-90%
</td>
<td style="text-align:left;">
35&lt;=
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
45462
</td>
<td style="text-align:left;">
Other
</td>
<td style="text-align:left;">
30-40%
</td>
<td style="text-align:left;">
0-35
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb237"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1"></a><span class="co"># recipe log regression</span></span>
<span id="cb237-2"><a href="#cb237-2"></a>recipe_class_logreg_spec &lt;-<span class="st"> </span><span class="kw">recipe</span>(final_result <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb237-3"><a href="#cb237-3"></a><span class="st">  </span><span class="kw">update_role</span>(code_presentation, id_student, <span class="dt">new_role =</span> <span class="st">&quot;Identification&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb237-4"><a href="#cb237-4"></a><span class="st">  </span><span class="kw">step_ordinalscore</span>(highest_education, imd_band, age_band) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb237-5"><a href="#cb237-5"></a><span class="st">  </span><span class="kw">step_dummy</span>(<span class="kw">all_predictors</span>(), <span class="op">-</span>num_of_prev_attempts, <span class="op">-</span>age_band, <span class="op">-</span>imd_band, <span class="op">-</span>highest_education)</span>
<span id="cb237-6"><a href="#cb237-6"></a></span>
<span id="cb237-7"><a href="#cb237-7"></a><span class="co"># dataset para o log regression</span></span>
<span id="cb237-8"><a href="#cb237-8"></a><span class="kw">kbl</span>(recipe_class_logreg_spec <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">prep</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">juice</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()) <span class="op">%&gt;%</span></span>
<span id="cb237-9"><a href="#cb237-9"></a><span class="st">  </span><span class="kw">kable_paper</span>(<span class="st">&quot;striped&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb237-10"><a href="#cb237-10"></a><span class="st">  </span><span class="kw">scroll_box</span>(<span class="dt">width =</span> <span class="st">&quot;100%&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class=" lightable-paper lightable-striped" style="font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
code_presentation
</th>
<th style="text-align:right;">
id_student
</th>
<th style="text-align:right;">
highest_education
</th>
<th style="text-align:right;">
imd_band
</th>
<th style="text-align:right;">
age_band
</th>
<th style="text-align:right;">
num_of_prev_attempts
</th>
<th style="text-align:left;">
final_result
</th>
<th style="text-align:right;">
code_module_Curso.B
</th>
<th style="text-align:right;">
code_module_Curso.C
</th>
<th style="text-align:right;">
code_module_Curso.D
</th>
<th style="text-align:right;">
code_module_Curso.E
</th>
<th style="text-align:right;">
code_module_Curso.F
</th>
<th style="text-align:right;">
code_module_Curso.G
</th>
<th style="text-align:right;">
gender_F
</th>
<th style="text-align:right;">
region_Scotland
</th>
<th style="text-align:right;">
region_North.Western.Region
</th>
<th style="text-align:right;">
region_South.East.Region
</th>
<th style="text-align:right;">
region_West.Midlands.Region
</th>
<th style="text-align:right;">
region_Wales
</th>
<th style="text-align:right;">
region_North.Region
</th>
<th style="text-align:right;">
region_South.Region
</th>
<th style="text-align:right;">
region_Ireland
</th>
<th style="text-align:right;">
region_South.West.Region
</th>
<th style="text-align:right;">
region_East.Midlands.Region
</th>
<th style="text-align:right;">
region_Yorkshire.Region
</th>
<th style="text-align:right;">
region_London.Region
</th>
<th style="text-align:right;">
disability_Y
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
28400
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
30268
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Fail
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
31604
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
32885
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
38053
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2013J
</td>
<td style="text-align:right;">
45462
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>
</table>
</div>
<p>Vamos agora a criação dos workflows, muito similar ao que fizemos anteriormente.</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1"></a><span class="co"># models</span></span>
<span id="cb238-2"><a href="#cb238-2"></a>model_lr &lt;-<span class="st"> </span><span class="kw">logistic_reg</span>(<span class="dt">mode =</span> <span class="st">&quot;classification&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb238-3"><a href="#cb238-3"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;glm&quot;</span>)</span>
<span id="cb238-4"><a href="#cb238-4"></a></span>
<span id="cb238-5"><a href="#cb238-5"></a><span class="co"># Os parâmetros escolhidos no random forest </span></span>
<span id="cb238-6"><a href="#cb238-6"></a><span class="co"># foram obtidos de uma etapa prévia de tunning</span></span>
<span id="cb238-7"><a href="#cb238-7"></a>model_rf &lt;-<span class="st"> </span><span class="kw">rand_forest</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb238-8"><a href="#cb238-8"></a><span class="st">  </span><span class="kw">set_engine</span>(<span class="st">&quot;ranger&quot;</span>, </span>
<span id="cb238-9"><a href="#cb238-9"></a>             <span class="dt">importance =</span> <span class="st">&quot;impurity&quot;</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># variable importance</span></span>
<span id="cb238-10"><a href="#cb238-10"></a><span class="st">  </span><span class="kw">set_mode</span>(<span class="st">&quot;classification&quot;</span>)</span>
<span id="cb238-11"><a href="#cb238-11"></a></span>
<span id="cb238-12"><a href="#cb238-12"></a><span class="co"># workflow</span></span>
<span id="cb238-13"><a href="#cb238-13"></a>lr_wflow &lt;-<span class="st"> </span><span class="kw">workflow</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb238-14"><a href="#cb238-14"></a><span class="st">  </span><span class="kw">add_recipe</span>(recipe_class_logreg_spec) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb238-15"><a href="#cb238-15"></a><span class="st">  </span><span class="kw">add_model</span>(model_lr)</span>
<span id="cb238-16"><a href="#cb238-16"></a></span>
<span id="cb238-17"><a href="#cb238-17"></a>rf_wflow &lt;-<span class="st"> </span><span class="kw">workflow</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb238-18"><a href="#cb238-18"></a><span class="st">  </span><span class="kw">add_recipe</span>(recipe_class_rf_spec) <span class="op">%&gt;%</span></span>
<span id="cb238-19"><a href="#cb238-19"></a><span class="st">  </span><span class="kw">add_model</span>(model_rf) </span></code></pre></div>
<p>Como tudo organizado, agora pode sim seguir para treino e predição dos modelos.</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1"></a><span class="co"># treino</span></span>
<span id="cb239-2"><a href="#cb239-2"></a><span class="co"># treino do modelo com logistic regression</span></span>
<span id="cb239-3"><a href="#cb239-3"></a>model_log_fit &lt;-<span class="st"> </span>lr_wflow <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb239-4"><a href="#cb239-4"></a><span class="st">  </span><span class="kw">fit</span>(<span class="dt">data =</span> train)</span>
<span id="cb239-5"><a href="#cb239-5"></a></span>
<span id="cb239-6"><a href="#cb239-6"></a><span class="co"># treino do modelo com random forest</span></span>
<span id="cb239-7"><a href="#cb239-7"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb239-8"><a href="#cb239-8"></a>model_rf_fit &lt;-<span class="st"> </span>rf_wflow <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb239-9"><a href="#cb239-9"></a><span class="st">  </span><span class="kw">fit</span>(<span class="dt">data =</span> train)</span>
<span id="cb239-10"><a href="#cb239-10"></a></span>
<span id="cb239-11"><a href="#cb239-11"></a><span class="co"># predições com o modelo treinado de logistic regression</span></span>
<span id="cb239-12"><a href="#cb239-12"></a>pred_lr &lt;-<span class="st"> </span><span class="kw">predict</span>(model_log_fit, test)</span>
<span id="cb239-13"><a href="#cb239-13"></a>pbp_pred_lr &lt;-<span class="st"> </span>pred_lr <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb239-14"><a href="#cb239-14"></a><span class="st">  </span><span class="kw">bind_cols</span>(test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(final_result)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb239-15"><a href="#cb239-15"></a><span class="st">  </span><span class="co"># adicionando coluna com as probabilidades</span></span>
<span id="cb239-16"><a href="#cb239-16"></a><span class="st">  </span><span class="kw">bind_cols</span>(<span class="kw">predict</span>(model_log_fit, test, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>))</span>
<span id="cb239-17"><a href="#cb239-17"></a></span>
<span id="cb239-18"><a href="#cb239-18"></a><span class="co"># predições com o modelo treinado de random forest</span></span>
<span id="cb239-19"><a href="#cb239-19"></a>pred_rf &lt;-<span class="st"> </span><span class="kw">predict</span>(model_rf_fit, test)</span>
<span id="cb239-20"><a href="#cb239-20"></a>pbp_pred_rf &lt;-<span class="st"> </span>pred_rf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb239-21"><a href="#cb239-21"></a><span class="st">  </span><span class="kw">bind_cols</span>(test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(final_result)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb239-22"><a href="#cb239-22"></a><span class="st">  </span><span class="co"># adicionando coluna com as probabilidades</span></span>
<span id="cb239-23"><a href="#cb239-23"></a><span class="st">  </span><span class="kw">bind_cols</span>(<span class="kw">predict</span>(model_rf_fit, test, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>))</span></code></pre></div>
<p>A saída de cada predição pode ser vista abaixo.</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1"></a><span class="co"># logistic regression</span></span>
<span id="cb240-2"><a href="#cb240-2"></a><span class="kw">kbl</span>(pbp_pred_lr <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()) <span class="op">%&gt;%</span></span>
<span id="cb240-3"><a href="#cb240-3"></a><span class="st">  </span><span class="kw">kable_paper</span>(<span class="st">&quot;striped&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb240-4"><a href="#cb240-4"></a><span class="st">  </span><span class="kw">scroll_box</span>(<span class="dt">width =</span> <span class="st">&quot;100%&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class=" lightable-paper lightable-striped" style="font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.pred_class
</th>
<th style="text-align:left;">
final_result
</th>
<th style="text-align:right;">
.pred_Fail
</th>
<th style="text-align:right;">
.pred_Pass
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0.2413768
</td>
<td style="text-align:right;">
0.7586232
</td>
</tr>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0.2560620
</td>
<td style="text-align:right;">
0.7439380
</td>
</tr>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0.1985814
</td>
<td style="text-align:right;">
0.8014186
</td>
</tr>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0.4429936
</td>
<td style="text-align:right;">
0.5570064
</td>
</tr>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0.2799435
</td>
<td style="text-align:right;">
0.7200565
</td>
</tr>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Fail
</td>
<td style="text-align:right;">
0.2490112
</td>
<td style="text-align:right;">
0.7509888
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1"></a><span class="co"># random forest</span></span>
<span id="cb241-2"><a href="#cb241-2"></a><span class="kw">kbl</span>(pbp_pred_rf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()) <span class="op">%&gt;%</span></span>
<span id="cb241-3"><a href="#cb241-3"></a><span class="st">  </span><span class="kw">kable_paper</span>(<span class="st">&quot;striped&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb241-4"><a href="#cb241-4"></a><span class="st">  </span><span class="kw">scroll_box</span>(<span class="dt">width =</span> <span class="st">&quot;100%&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class=" lightable-paper lightable-striped" style="font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.pred_class
</th>
<th style="text-align:left;">
final_result
</th>
<th style="text-align:right;">
.pred_Fail
</th>
<th style="text-align:right;">
.pred_Pass
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0.2408118
</td>
<td style="text-align:right;">
0.7591882
</td>
</tr>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0.3294932
</td>
<td style="text-align:right;">
0.6705068
</td>
</tr>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0.3030805
</td>
<td style="text-align:right;">
0.6969195
</td>
</tr>
<tr>
<td style="text-align:left;">
Fail
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0.5796345
</td>
<td style="text-align:right;">
0.4203655
</td>
</tr>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:right;">
0.4826122
</td>
<td style="text-align:right;">
0.5173878
</td>
</tr>
<tr>
<td style="text-align:left;">
Pass
</td>
<td style="text-align:left;">
Fail
</td>
<td style="text-align:right;">
0.3074697
</td>
<td style="text-align:right;">
0.6925303
</td>
</tr>
</tbody>
</table>
</div>
<p>E por fim avaliação das nossas métricas.</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1"></a><span class="co"># Random Forest -------------------------------------------------------</span></span>
<span id="cb242-2"><a href="#cb242-2"></a><span class="co"># acurácia e kap</span></span>
<span id="cb242-3"><a href="#cb242-3"></a>pbp_pred_rf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb242-4"><a href="#cb242-4"></a><span class="st">  </span><span class="kw">metrics</span>(<span class="dt">truth =</span> final_result, </span>
<span id="cb242-5"><a href="#cb242-5"></a>          .pred_class)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.603
## 2 kap      binary         0.196</code></pre>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1"></a><span class="co"># confusion matrix</span></span>
<span id="cb244-2"><a href="#cb244-2"></a>pbp_pred_rf <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb244-3"><a href="#cb244-3"></a><span class="st">  </span><span class="kw">conf_mat</span>(final_result, .pred_class)</span></code></pre></div>
<pre><code>##           Truth
## Prediction Fail Pass
##       Fail 3441 2141
##       Pass 1607 2255</code></pre>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1"></a><span class="co"># Log reg ----------------------</span></span>
<span id="cb246-2"><a href="#cb246-2"></a><span class="co"># acurácia e kap</span></span>
<span id="cb246-3"><a href="#cb246-3"></a>pbp_pred_lr <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb246-4"><a href="#cb246-4"></a><span class="st">  </span><span class="kw">metrics</span>(<span class="dt">truth =</span> final_result, </span>
<span id="cb246-5"><a href="#cb246-5"></a>          .pred_class)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.585
## 2 kap      binary         0.158</code></pre>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1"></a><span class="co"># confusion matrix</span></span>
<span id="cb248-2"><a href="#cb248-2"></a>pbp_pred_lr <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb248-3"><a href="#cb248-3"></a><span class="st">  </span><span class="kw">conf_mat</span>(final_result, .pred_class)</span></code></pre></div>
<pre><code>##           Truth
## Prediction Fail Pass
##       Fail 3444 2311
##       Pass 1604 2085</code></pre>
<p>Nesse momento nós temos duas informações importantes sobre nossos modelos, acurácia e confusion matrix. A acurácia do random forest é alguns pontos maior que a do logistic regression, porém o modelo de logistic regression se saiu melhor em identificar estudantes que seriam reprovados (Fail).</p>
<p>Eu prefiro analisar uma outra métrica a ROC AUC, pois é uma métrica mais robusta quando comparada as outras.</p>
<p>Visualizando a curva ROC para os dois modelos.</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1"></a><span class="co"># lr roc auc</span></span>
<span id="cb250-2"><a href="#cb250-2"></a>roc_auc_lr &lt;-<span class="st"> </span>pbp_pred_lr <span class="op">%&gt;%</span></span>
<span id="cb250-3"><a href="#cb250-3"></a><span class="st">  </span><span class="kw">roc_curve</span>(<span class="dt">truth =</span> final_result,</span>
<span id="cb250-4"><a href="#cb250-4"></a>          .pred_Fail) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb250-5"><a href="#cb250-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="st">&quot;Logistic Regression&quot;</span>)</span>
<span id="cb250-6"><a href="#cb250-6"></a></span>
<span id="cb250-7"><a href="#cb250-7"></a><span class="co"># rf roc auc</span></span>
<span id="cb250-8"><a href="#cb250-8"></a>roc_auc_rf &lt;-<span class="st"> </span>pbp_pred_rf <span class="op">%&gt;%</span></span>
<span id="cb250-9"><a href="#cb250-9"></a><span class="st">  </span><span class="kw">roc_curve</span>(<span class="dt">truth =</span> final_result,</span>
<span id="cb250-10"><a href="#cb250-10"></a>            .pred_Fail)<span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb250-11"><a href="#cb250-11"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="st">&quot;Random Forest&quot;</span>)</span>
<span id="cb250-12"><a href="#cb250-12"></a></span>
<span id="cb250-13"><a href="#cb250-13"></a>geral_roc_auc &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(roc_auc_lr, roc_auc_rf)</span>
<span id="cb250-14"><a href="#cb250-14"></a></span>
<span id="cb250-15"><a href="#cb250-15"></a>geral_roc_auc <span class="op">%&gt;%</span></span>
<span id="cb250-16"><a href="#cb250-16"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>specificity,</span>
<span id="cb250-17"><a href="#cb250-17"></a>             <span class="dt">y =</span> sensitivity,</span>
<span id="cb250-18"><a href="#cb250-18"></a>             <span class="dt">color =</span> model)) <span class="op">+</span></span>
<span id="cb250-19"><a href="#cb250-19"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="fl">1.5</span>, <span class="dt">alpha =</span> <span class="fl">.7</span>) <span class="op">+</span></span>
<span id="cb250-20"><a href="#cb250-20"></a><span class="st">    </span><span class="kw">geom_abline</span>(</span>
<span id="cb250-21"><a href="#cb250-21"></a>    <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb250-22"><a href="#cb250-22"></a>    <span class="dt">color =</span> <span class="st">&quot;gray50&quot;</span>,</span>
<span id="cb250-23"><a href="#cb250-23"></a>    <span class="dt">size =</span> <span class="fl">.8</span></span>
<span id="cb250-24"><a href="#cb250-24"></a>  ) <span class="op">+</span></span>
<span id="cb250-25"><a href="#cb250-25"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#329429&quot;</span>, <span class="st">&quot;#23664B&quot;</span>)) <span class="op">+</span></span>
<span id="cb250-26"><a href="#cb250-26"></a><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb250-27"><a href="#cb250-27"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb250-28"><a href="#cb250-28"></a>    <span class="dt">title =</span> <span class="st">&quot;Curva ROC dos dois modelos utilizados&quot;</span></span>
<span id="cb250-29"><a href="#cb250-29"></a>  )</span></code></pre></div>
<p><img src="etapa2_3_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p>Assim vemos que o random forest se saiu melhor, pois possui uma área maior abaixo da curva.</p>
<p>Nesse ponto eu fiz mais um tunning, dessa vez para o xgboost e random forest, como o procedimento levou um certo tempo, eu preferir deixar o código comentado e salvei os modelos já treinados, que você pode encontrar na pasta do projeto.</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1"></a><span class="co"># estimate perfomance with cross validation</span></span>
<span id="cb251-2"><a href="#cb251-2"></a><span class="co"># set.seed(123)</span></span>
<span id="cb251-3"><a href="#cb251-3"></a><span class="co"># score_fold &lt;- vfold_cv(train, v = 5, strata = final_result)</span></span>
<span id="cb251-4"><a href="#cb251-4"></a><span class="co"># </span></span>
<span id="cb251-5"><a href="#cb251-5"></a></span>
<span id="cb251-6"><a href="#cb251-6"></a><span class="co"># xgboost -------------------------------------------------------</span></span>
<span id="cb251-7"><a href="#cb251-7"></a><span class="co"># tune_xgb &lt;- boost_tree(</span></span>
<span id="cb251-8"><a href="#cb251-8"></a><span class="co">#   trees = 1000,</span></span>
<span id="cb251-9"><a href="#cb251-9"></a><span class="co">#   tree_depth = tune(), min_n = tune(),</span></span>
<span id="cb251-10"><a href="#cb251-10"></a><span class="co">#   loss_reduction = tune(),                     ## first three: model complexity</span></span>
<span id="cb251-11"><a href="#cb251-11"></a><span class="co">#   sample_size = tune(), mtry = tune(),         ## randomness</span></span>
<span id="cb251-12"><a href="#cb251-12"></a><span class="co">#   learn_rate = tune(),                         ## step size</span></span>
<span id="cb251-13"><a href="#cb251-13"></a><span class="co"># ) %&gt;%</span></span>
<span id="cb251-14"><a href="#cb251-14"></a><span class="co">#   set_engine(&quot;xgboost&quot;) %&gt;%</span></span>
<span id="cb251-15"><a href="#cb251-15"></a><span class="co">#   set_mode(&quot;classification&quot;)</span></span>
<span id="cb251-16"><a href="#cb251-16"></a><span class="co"># </span></span>
<span id="cb251-17"><a href="#cb251-17"></a><span class="co"># </span></span>
<span id="cb251-18"><a href="#cb251-18"></a><span class="co"># # Tunning Workflow</span></span>
<span id="cb251-19"><a href="#cb251-19"></a><span class="co"># </span></span>
<span id="cb251-20"><a href="#cb251-20"></a><span class="co"># tune_xgb_wflw &lt;- workflow() %&gt;%</span></span>
<span id="cb251-21"><a href="#cb251-21"></a><span class="co">#   add_model(tune_xgb) %&gt;%</span></span>
<span id="cb251-22"><a href="#cb251-22"></a><span class="co">#   add_recipe(recipe_class_logreg_spec)</span></span>
<span id="cb251-23"><a href="#cb251-23"></a><span class="co"># </span></span>
<span id="cb251-24"><a href="#cb251-24"></a><span class="co"># </span></span>
<span id="cb251-25"><a href="#cb251-25"></a><span class="co"># # Tunning grid</span></span>
<span id="cb251-26"><a href="#cb251-26"></a><span class="co"># </span></span>
<span id="cb251-27"><a href="#cb251-27"></a><span class="co"># xgb_grid &lt;- grid_latin_hypercube(</span></span>
<span id="cb251-28"><a href="#cb251-28"></a><span class="co">#   tree_depth(),</span></span>
<span id="cb251-29"><a href="#cb251-29"></a><span class="co">#   min_n(),</span></span>
<span id="cb251-30"><a href="#cb251-30"></a><span class="co">#   loss_reduction(),</span></span>
<span id="cb251-31"><a href="#cb251-31"></a><span class="co">#   sample_size = sample_prop(),</span></span>
<span id="cb251-32"><a href="#cb251-32"></a><span class="co">#   finalize(mtry(), train),</span></span>
<span id="cb251-33"><a href="#cb251-33"></a><span class="co">#   learn_rate(),</span></span>
<span id="cb251-34"><a href="#cb251-34"></a><span class="co">#   size = 30</span></span>
<span id="cb251-35"><a href="#cb251-35"></a><span class="co"># )</span></span>
<span id="cb251-36"><a href="#cb251-36"></a><span class="co"># </span></span>
<span id="cb251-37"><a href="#cb251-37"></a><span class="co"># tictoc::tic()</span></span>
<span id="cb251-38"><a href="#cb251-38"></a><span class="co"># tune_res &lt;- tune_grid(</span></span>
<span id="cb251-39"><a href="#cb251-39"></a><span class="co">#   tune_xgb_wflw,</span></span>
<span id="cb251-40"><a href="#cb251-40"></a><span class="co">#   resamples = score_fold,</span></span>
<span id="cb251-41"><a href="#cb251-41"></a><span class="co">#   grid = xgb_grid, # 15 combos of model parameters</span></span>
<span id="cb251-42"><a href="#cb251-42"></a><span class="co">#   control = control_grid(verbose = TRUE, save_pred = TRUE),</span></span>
<span id="cb251-43"><a href="#cb251-43"></a><span class="co">#   metrics = metric_set(accuracy, kap, roc_auc)</span></span>
<span id="cb251-44"><a href="#cb251-44"></a><span class="co"># )</span></span>
<span id="cb251-45"><a href="#cb251-45"></a><span class="co"># tictoc::toc()</span></span>
<span id="cb251-46"><a href="#cb251-46"></a><span class="co"># </span></span>
<span id="cb251-47"><a href="#cb251-47"></a><span class="co"># best_fit_auc &lt;- select_best(tune_res, &quot;roc_auc&quot;)</span></span>
<span id="cb251-48"><a href="#cb251-48"></a><span class="co"># </span></span>
<span id="cb251-49"><a href="#cb251-49"></a><span class="co"># tune_res %&gt;% show_best(metric =&quot;roc_auc&quot;)</span></span>
<span id="cb251-50"><a href="#cb251-50"></a><span class="co"># </span></span>
<span id="cb251-51"><a href="#cb251-51"></a><span class="co"># # Finalizando com o melhor modelo do tunning</span></span>
<span id="cb251-52"><a href="#cb251-52"></a><span class="co"># final_xgb &lt;- finalize_workflow(</span></span>
<span id="cb251-53"><a href="#cb251-53"></a><span class="co">#   tune_xgb_wflw,</span></span>
<span id="cb251-54"><a href="#cb251-54"></a><span class="co">#   best_fit_auc</span></span>
<span id="cb251-55"><a href="#cb251-55"></a><span class="co"># )</span></span>
<span id="cb251-56"><a href="#cb251-56"></a><span class="co"># </span></span>
<span id="cb251-57"><a href="#cb251-57"></a><span class="co"># # treino</span></span>
<span id="cb251-58"><a href="#cb251-58"></a><span class="co"># # treino do modelo com logistic regression</span></span>
<span id="cb251-59"><a href="#cb251-59"></a><span class="co"># model_xgb_best_fit &lt;- final_xgb %&gt;% </span></span>
<span id="cb251-60"><a href="#cb251-60"></a><span class="co">#   fit(data = train)</span></span>
<span id="cb251-61"><a href="#cb251-61"></a><span class="co"># </span></span>
<span id="cb251-62"><a href="#cb251-62"></a><span class="co"># saveRDS(model_xgb_best_fit, &quot;model_xgb_best_fit.rds&quot;)</span></span>
<span id="cb251-63"><a href="#cb251-63"></a></span>
<span id="cb251-64"><a href="#cb251-64"></a></span>
<span id="cb251-65"><a href="#cb251-65"></a><span class="co"># random forest ------------------------------------------</span></span>
<span id="cb251-66"><a href="#cb251-66"></a><span class="co"># rf_tuning_spec &lt;- rand_forest(</span></span>
<span id="cb251-67"><a href="#cb251-67"></a><span class="co">#   mtry = tune(),</span></span>
<span id="cb251-68"><a href="#cb251-68"></a><span class="co">#   trees = 1000,</span></span>
<span id="cb251-69"><a href="#cb251-69"></a><span class="co">#   min_n = tune()</span></span>
<span id="cb251-70"><a href="#cb251-70"></a><span class="co"># ) %&gt;%</span></span>
<span id="cb251-71"><a href="#cb251-71"></a><span class="co">#   set_mode(&quot;classification&quot;) %&gt;%</span></span>
<span id="cb251-72"><a href="#cb251-72"></a><span class="co">#   set_engine(&quot;ranger&quot;)</span></span>
<span id="cb251-73"><a href="#cb251-73"></a><span class="co"># # </span></span>
<span id="cb251-74"><a href="#cb251-74"></a><span class="co"># tune_rf_wf &lt;- workflow() %&gt;%</span></span>
<span id="cb251-75"><a href="#cb251-75"></a><span class="co">#   add_model(rf_tuning_spec) %&gt;%</span></span>
<span id="cb251-76"><a href="#cb251-76"></a><span class="co">#   add_recipe(recipe_class_spec)</span></span>
<span id="cb251-77"><a href="#cb251-77"></a><span class="co"># </span></span>
<span id="cb251-78"><a href="#cb251-78"></a><span class="co"># tictoc::tic()</span></span>
<span id="cb251-79"><a href="#cb251-79"></a><span class="co"># tune_res &lt;- tune_grid(</span></span>
<span id="cb251-80"><a href="#cb251-80"></a><span class="co">#   tune_rf_wf,</span></span>
<span id="cb251-81"><a href="#cb251-81"></a><span class="co">#   resamples = score_fold,</span></span>
<span id="cb251-82"><a href="#cb251-82"></a><span class="co">#   grid = 10, # 15 combos of model parameters</span></span>
<span id="cb251-83"><a href="#cb251-83"></a><span class="co">#   control = control_grid(verbose = TRUE, save_pred = TRUE),</span></span>
<span id="cb251-84"><a href="#cb251-84"></a><span class="co">#   metrics = metric_set(accuracy, kap, roc_auc)</span></span>
<span id="cb251-85"><a href="#cb251-85"></a><span class="co"># )</span></span>
<span id="cb251-86"><a href="#cb251-86"></a><span class="co"># tictoc::toc()</span></span>
<span id="cb251-87"><a href="#cb251-87"></a><span class="co"># </span></span>
<span id="cb251-88"><a href="#cb251-88"></a><span class="co"># best_fit_auc &lt;- select_best(tune_res, &quot;roc_auc&quot;)</span></span>
<span id="cb251-89"><a href="#cb251-89"></a><span class="co"># </span></span>
<span id="cb251-90"><a href="#cb251-90"></a><span class="co"># tune_res %&gt;% show_best(metric =&quot;roc_auc&quot;)</span></span>
<span id="cb251-91"><a href="#cb251-91"></a><span class="co"># </span></span>
<span id="cb251-92"><a href="#cb251-92"></a><span class="co"># # Finalizando com o melhor modelo do tunning</span></span>
<span id="cb251-93"><a href="#cb251-93"></a><span class="co"># final_rf &lt;- finalize_workflow(</span></span>
<span id="cb251-94"><a href="#cb251-94"></a><span class="co">#   tune_rf_wf,</span></span>
<span id="cb251-95"><a href="#cb251-95"></a><span class="co">#   best_fit_auc</span></span>
<span id="cb251-96"><a href="#cb251-96"></a><span class="co"># )</span></span>
<span id="cb251-97"><a href="#cb251-97"></a><span class="co"># </span></span>
<span id="cb251-98"><a href="#cb251-98"></a><span class="co"># saveRDS(final_rf, &quot;final_rf.rds&quot;)</span></span></code></pre></div>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1"></a>model_xgb_best_fit &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;model_xgb_best_fit.rds&quot;</span>)</span>
<span id="cb252-2"><a href="#cb252-2"></a></span>
<span id="cb252-3"><a href="#cb252-3"></a><span class="co"># predições com o modelo treinado de logistic regression</span></span>
<span id="cb252-4"><a href="#cb252-4"></a>pred_xgb_tuned &lt;-<span class="st"> </span><span class="kw">predict</span>(model_xgb_best_fit, test)</span>
<span id="cb252-5"><a href="#cb252-5"></a>pbp_pred_xg &lt;-<span class="st"> </span>pred_xgb_tuned <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb252-6"><a href="#cb252-6"></a><span class="st">  </span><span class="kw">bind_cols</span>(test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(final_result)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb252-7"><a href="#cb252-7"></a><span class="st">  </span><span class="co"># adicionando coluna com as probabilidades</span></span>
<span id="cb252-8"><a href="#cb252-8"></a><span class="st">  </span><span class="kw">bind_cols</span>(<span class="kw">predict</span>(model_xgb_best_fit, test, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>))</span>
<span id="cb252-9"><a href="#cb252-9"></a></span>
<span id="cb252-10"><a href="#cb252-10"></a><span class="co"># xgb -------------------------------------------------------</span></span>
<span id="cb252-11"><a href="#cb252-11"></a><span class="co"># acurácia e kap</span></span>
<span id="cb252-12"><a href="#cb252-12"></a>pbp_pred_xg <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb252-13"><a href="#cb252-13"></a><span class="st">  </span><span class="kw">metrics</span>(<span class="dt">truth =</span> final_result, </span>
<span id="cb252-14"><a href="#cb252-14"></a>          .pred_class)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.613
## 2 kap      binary         0.216</code></pre>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="#cb254-1"></a><span class="co"># confusion matrix</span></span>
<span id="cb254-2"><a href="#cb254-2"></a>pbp_pred_xg <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb254-3"><a href="#cb254-3"></a><span class="st">  </span><span class="kw">conf_mat</span>(final_result, .pred_class)</span></code></pre></div>
<pre><code>##           Truth
## Prediction Fail Pass
##       Fail 3487 2094
##       Pass 1561 2302</code></pre>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="#cb256-1"></a><span class="co"># random forest -------------------------------------------</span></span>
<span id="cb256-2"><a href="#cb256-2"></a>final_rf &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;final_rf.rds&quot;</span>)</span>
<span id="cb256-3"><a href="#cb256-3"></a></span>
<span id="cb256-4"><a href="#cb256-4"></a>model_rf_best_fit &lt;-<span class="st"> </span>final_rf <span class="op">%&gt;%</span></span>
<span id="cb256-5"><a href="#cb256-5"></a><span class="st">  </span><span class="kw">fit</span>(<span class="dt">data =</span> train)</span>
<span id="cb256-6"><a href="#cb256-6"></a></span>
<span id="cb256-7"><a href="#cb256-7"></a>pred_rf &lt;-<span class="st"> </span><span class="kw">predict</span>(model_rf_best_fit, test)</span>
<span id="cb256-8"><a href="#cb256-8"></a>pbp_pred_rf &lt;-<span class="st"> </span>pred_rf <span class="op">%&gt;%</span></span>
<span id="cb256-9"><a href="#cb256-9"></a><span class="st">  </span><span class="kw">bind_cols</span>(test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(final_result)) <span class="op">%&gt;%</span></span>
<span id="cb256-10"><a href="#cb256-10"></a><span class="st">  </span><span class="kw">bind_cols</span>(<span class="kw">predict</span>(model_rf_best_fit, test, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>))</span>
<span id="cb256-11"><a href="#cb256-11"></a></span>
<span id="cb256-12"><a href="#cb256-12"></a><span class="co"># acurácia e kap</span></span>
<span id="cb256-13"><a href="#cb256-13"></a>pbp_pred_rf <span class="op">%&gt;%</span></span>
<span id="cb256-14"><a href="#cb256-14"></a><span class="st">  </span><span class="kw">metrics</span>(<span class="dt">truth =</span> final_result,</span>
<span id="cb256-15"><a href="#cb256-15"></a>          .pred_class)</span></code></pre></div>
<pre><code>## # A tibble: 2 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.605
## 2 kap      binary         0.198</code></pre>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1"></a><span class="co"># confusion matrix</span></span>
<span id="cb258-2"><a href="#cb258-2"></a>pbp_pred_rf <span class="op">%&gt;%</span></span>
<span id="cb258-3"><a href="#cb258-3"></a><span class="st">  </span><span class="kw">conf_mat</span>(final_result, .pred_class)</span></code></pre></div>
<pre><code>##           Truth
## Prediction Fail Pass
##       Fail 3511 2195
##       Pass 1537 2201</code></pre>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1"></a><span class="co"># roc_auc</span></span>
<span id="cb260-2"><a href="#cb260-2"></a>roc_auc_xg_tuned &lt;-<span class="st"> </span>pbp_pred_xg <span class="op">%&gt;%</span></span>
<span id="cb260-3"><a href="#cb260-3"></a><span class="st">  </span><span class="kw">roc_curve</span>(<span class="dt">truth =</span> final_result,</span>
<span id="cb260-4"><a href="#cb260-4"></a>          .pred_Fail) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb260-5"><a href="#cb260-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="st">&quot;Xgboost - Tunned&quot;</span>)</span>
<span id="cb260-6"><a href="#cb260-6"></a></span>
<span id="cb260-7"><a href="#cb260-7"></a><span class="co"># Visualizando a roc_curve</span></span>
<span id="cb260-8"><a href="#cb260-8"></a>roc_auc_rf_tuned &lt;-<span class="st"> </span>pbp_pred_rf <span class="op">%&gt;%</span></span>
<span id="cb260-9"><a href="#cb260-9"></a><span class="st">  </span><span class="kw">roc_curve</span>(<span class="dt">truth =</span> final_result,</span>
<span id="cb260-10"><a href="#cb260-10"></a>            .pred_Fail) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb260-11"><a href="#cb260-11"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="st">&quot;Random Forest - Tunned&quot;</span>)</span>
<span id="cb260-12"><a href="#cb260-12"></a></span>
<span id="cb260-13"><a href="#cb260-13"></a>geral_roc_auc &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(roc_auc_lr, roc_auc_rf, roc_auc_xg_tuned, roc_auc_rf_tuned)</span>
<span id="cb260-14"><a href="#cb260-14"></a></span>
<span id="cb260-15"><a href="#cb260-15"></a>geral_roc_auc <span class="op">%&gt;%</span></span>
<span id="cb260-16"><a href="#cb260-16"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>specificity,</span>
<span id="cb260-17"><a href="#cb260-17"></a>             <span class="dt">y =</span> sensitivity,</span>
<span id="cb260-18"><a href="#cb260-18"></a>             <span class="dt">color =</span> model)) <span class="op">+</span></span>
<span id="cb260-19"><a href="#cb260-19"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="fl">1.5</span>, <span class="dt">alpha =</span> <span class="fl">.7</span>) <span class="op">+</span></span>
<span id="cb260-20"><a href="#cb260-20"></a><span class="st">    </span><span class="kw">geom_abline</span>(</span>
<span id="cb260-21"><a href="#cb260-21"></a>    <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb260-22"><a href="#cb260-22"></a>    <span class="dt">color =</span> <span class="st">&quot;gray50&quot;</span>,</span>
<span id="cb260-23"><a href="#cb260-23"></a>    <span class="dt">size =</span> <span class="fl">.8</span></span>
<span id="cb260-24"><a href="#cb260-24"></a>  ) <span class="op">+</span></span>
<span id="cb260-25"><a href="#cb260-25"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#329429&quot;</span>, <span class="st">&quot;#23664B&quot;</span>, <span class="st">&quot;#1BA673&quot;</span>, <span class="st">&quot;#8C520A&quot;</span>)) <span class="op">+</span></span>
<span id="cb260-26"><a href="#cb260-26"></a><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb260-27"><a href="#cb260-27"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb260-28"><a href="#cb260-28"></a>    <span class="dt">title =</span> <span class="st">&quot;Curva ROC dos dois modelos utilizados&quot;</span></span>
<span id="cb260-29"><a href="#cb260-29"></a>  )</span></code></pre></div>
<p><img src="etapa2_3_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="#cb261-1"></a><span class="co"># roc_auc all models</span></span>
<span id="cb261-2"><a href="#cb261-2"></a>roc_auc_lr_values &lt;-<span class="st"> </span>pbp_pred_lr <span class="op">%&gt;%</span></span>
<span id="cb261-3"><a href="#cb261-3"></a><span class="st">  </span><span class="kw">roc_auc</span>(<span class="dt">truth =</span> final_result,</span>
<span id="cb261-4"><a href="#cb261-4"></a>          .pred_Fail) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb261-5"><a href="#cb261-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="st">&quot;Logistic Regression&quot;</span>)</span>
<span id="cb261-6"><a href="#cb261-6"></a></span>
<span id="cb261-7"><a href="#cb261-7"></a>roc_auc_rf_values &lt;-<span class="st"> </span>pbp_pred_rf <span class="op">%&gt;%</span></span>
<span id="cb261-8"><a href="#cb261-8"></a><span class="st">  </span><span class="kw">roc_auc</span>(<span class="dt">truth =</span> final_result,</span>
<span id="cb261-9"><a href="#cb261-9"></a>            .pred_Fail)<span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb261-10"><a href="#cb261-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="st">&quot;Random Forest&quot;</span>)</span>
<span id="cb261-11"><a href="#cb261-11"></a></span>
<span id="cb261-12"><a href="#cb261-12"></a>roc_auc_xg_tuned_values &lt;-<span class="st"> </span>pbp_pred_xg <span class="op">%&gt;%</span></span>
<span id="cb261-13"><a href="#cb261-13"></a><span class="st">  </span><span class="kw">roc_auc</span>(<span class="dt">truth =</span> final_result,</span>
<span id="cb261-14"><a href="#cb261-14"></a>          .pred_Fail) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb261-15"><a href="#cb261-15"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="st">&quot;Xgboost - Tunned&quot;</span>)</span>
<span id="cb261-16"><a href="#cb261-16"></a></span>
<span id="cb261-17"><a href="#cb261-17"></a>roc_auc_rf_tuned_values &lt;-<span class="st"> </span>pbp_pred_rf <span class="op">%&gt;%</span></span>
<span id="cb261-18"><a href="#cb261-18"></a><span class="st">  </span><span class="kw">roc_auc</span>(<span class="dt">truth =</span> final_result,</span>
<span id="cb261-19"><a href="#cb261-19"></a>            .pred_Fail) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb261-20"><a href="#cb261-20"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">model =</span> <span class="st">&quot;Random Forest - Tunned&quot;</span>)</span>
<span id="cb261-21"><a href="#cb261-21"></a></span>
<span id="cb261-22"><a href="#cb261-22"></a>geral_roc_auc_values &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(roc_auc_lr_values, roc_auc_rf_values, roc_auc_xg_tuned_values, roc_auc_rf_tuned_values) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(.estimate))</span>
<span id="cb261-23"><a href="#cb261-23"></a></span>
<span id="cb261-24"><a href="#cb261-24"></a><span class="co"># tabela com todos os quatro modelos treinados</span></span>
<span id="cb261-25"><a href="#cb261-25"></a><span class="kw">kbl</span>(geral_roc_auc_values) <span class="op">%&gt;%</span></span>
<span id="cb261-26"><a href="#cb261-26"></a><span class="st">  </span><span class="kw">kable_paper</span>(<span class="st">&quot;striped&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb261-27"><a href="#cb261-27"></a><span class="st">  </span><span class="kw">scroll_box</span>(<span class="dt">width =</span> <span class="st">&quot;100%&quot;</span>)</span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class=" lightable-paper lightable-striped" style="font-family: &quot;Arial Narrow&quot;, arial, helvetica, sans-serif; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimator
</th>
<th style="text-align:right;">
.estimate
</th>
<th style="text-align:left;">
model
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
roc_auc
</td>
<td style="text-align:left;">
binary
</td>
<td style="text-align:right;">
0.6468450
</td>
<td style="text-align:left;">
Xgboost - Tunned
</td>
</tr>
<tr>
<td style="text-align:left;">
roc_auc
</td>
<td style="text-align:left;">
binary
</td>
<td style="text-align:right;">
0.6403568
</td>
<td style="text-align:left;">
Random Forest
</td>
</tr>
<tr>
<td style="text-align:left;">
roc_auc
</td>
<td style="text-align:left;">
binary
</td>
<td style="text-align:right;">
0.6403568
</td>
<td style="text-align:left;">
Random Forest - Tunned
</td>
</tr>
<tr>
<td style="text-align:left;">
roc_auc
</td>
<td style="text-align:left;">
binary
</td>
<td style="text-align:right;">
0.6119366
</td>
<td style="text-align:left;">
Logistic Regression
</td>
</tr>
</tbody>
</table>
</div>
<p>O que podemos ver, tanto pelo gráfico quanto pelas estimativas é que o xgboost performou melhor que os outros modelos quando avaliado nos dados de teste, e certamente será nossa escolha.</p>
<p>Por fim, eu trago aqui um plot de importância de variáveis, por ser um entendimento interessante para o negócio.</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1"></a><span class="kw">library</span>(vip)</span>
<span id="cb262-2"><a href="#cb262-2"></a><span class="co"># logistic_regression</span></span>
<span id="cb262-3"><a href="#cb262-3"></a>model_xgb_best_fit <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb262-4"><a href="#cb262-4"></a><span class="st">  </span><span class="kw">pull_workflow_fit</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb262-5"><a href="#cb262-5"></a><span class="st">  </span><span class="kw">vip</span>(<span class="dt">num_features =</span> <span class="dv">10</span>) <span class="op">+</span></span>
<span id="cb262-6"><a href="#cb262-6"></a><span class="st">  </span><span class="kw">geom_col</span>(<span class="dt">fill =</span> <span class="st">&quot;#23664B&quot;</span>) <span class="op">+</span></span>
<span id="cb262-7"><a href="#cb262-7"></a><span class="st">  </span><span class="kw">theme_minimal</span>() <span class="op">+</span></span>
<span id="cb262-8"><a href="#cb262-8"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb262-9"><a href="#cb262-9"></a>    <span class="dt">title =</span> <span class="st">&quot;Variáveis mais importantes </span><span class="ch">\n</span><span class="st">para o modelo de XGboost tunado&quot;</span></span>
<span id="cb262-10"><a href="#cb262-10"></a>  )</span></code></pre></div>
<p><img src="etapa2_3_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<p>Veja que o top 3 de variáveis mais importantes são:</p>
<ol style="list-style-type: decimal">
<li><code>highest_education</code></li>
<li><code>imd_band</code></li>
<li><code>num_of_prev_attempts</code></li>
</ol>
<p>Ambas relacionadas com o nível educacional prévio do estudante, nível de carência da região em que mora e se o mesmo é ou não repetente naquele curso.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
