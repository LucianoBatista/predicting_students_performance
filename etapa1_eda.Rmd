---
title: "Etapa 1: EDA"
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, dpi = 300, fig.align = "center", fig.width = 10, fig.height = 7)

```


Como dito anteriormente, nesta etapa você encontra a análise exploratório de dados (EDA).
<p style="margin-bottom:40px"></p>

# Libs

Abaixo está os pacotes utilizados para desenvolvimento da etapa 1 do desafio.

```{r}
library(tidyverse)
library(skimr)
library(data.table)
library(tidytable)
library(data.table)
library(lubridate)
library(tidytext)
library(ggridges)
library(sf)
library(geofacet)
library(rlang)
library(plotly)

```

Paleta de cores utilizadas ao longo da análise

```{r}
pallete_disc <- c("#12A661", "#1495B3", "#A67B24", "#482159", 
             "#D90D5B", "#165914", "#A61F0C", "#243B40", 
             "#165F66", "#1CA62D", "#A6341B")
pallete_2 <- c("#012623", "#038C73", "#1BA673", "#04BF68", "#04D960")
pallete_3 <- c("#D91A25", "#8C0A11", "#038C73", "#D9831A", "#8C520A")
pallete_4 <- c("#014034", "#1AD9B6", "#038C73", "#401200", "#8C2903")

```
<p style="margin-bottom:40px"></p>

# Dados

Leitura de todas as tabelas disponíveis na base de dados.

```{r}
assessments <- read_csv("data/assessments.csv") %>% 
    mutate(code_module = factor(code_module, 
                              levels = c("AAA", "BBB", 
                                         "CCC", "DDD", 
                                         "EEE", "FFF", 
                                         "GGG"),
                              labels = c("Curso A", "Curso B", 
                                         "Curso C", "Curso D", 
                                         "Curso E", "Curso F", 
                                         "Curso G")))

courses <- read_csv("data/courses.csv") %>% 
  mutate(code_module = factor(code_module, 
                              levels = c("AAA", "BBB", 
                                         "CCC", "DDD", 
                                         "EEE", "FFF", 
                                         "GGG"),
                              labels = c("Curso A", "Curso B", 
                                         "Curso C", "Curso D", 
                                         "Curso E", "Curso F", 
                                         "Curso G")))

vle <- read_csv("data/vle.csv") %>% 
  mutate(code_module = factor(code_module, 
                              levels = c("AAA", "BBB", 
                                         "CCC", "DDD", 
                                         "EEE", "FFF", 
                                         "GGG"),
                              labels = c("Curso A", "Curso B", 
                                         "Curso C", "Curso D", 
                                         "Curso E", "Curso F", 
                                         "Curso G")))

courses <- read_csv("data/courses.csv") %>% 
  mutate(code_module = factor(code_module, 
                              levels = c("AAA", "BBB", 
                                         "CCC", "DDD", 
                                         "EEE", "FFF", 
                                         "GGG"),
                              labels = c("Curso A", "Curso B", 
                                         "Curso C", "Curso D", 
                                         "Curso E", "Curso F", 
                                         "Curso G")))

# Fatores Demográficos
student_info <- read_csv("data/studentInfo.csv") %>% 
  mutate(code_module = factor(code_module, 
                              levels = c("AAA", "BBB", 
                                         "CCC", "DDD", 
                                         "EEE", "FFF", 
                                         "GGG"),
                              labels = c("Curso A", "Curso B", 
                                         "Curso C", "Curso D", 
                                         "Curso E", "Curso F", 
                                         "Curso G")))

# Dados sobre interação dos estudantes com ambiente online
student_registration <- read_csv("data/studentRegistration.csv") %>% 
  mutate(code_module = factor(code_module, 
                              levels = c("AAA", "BBB", 
                                         "CCC", "DDD", 
                                         "EEE", "FFF", 
                                         "GGG"),
                              labels = c("Curso A", "Curso B", 
                                         "Curso C", "Curso D", 
                                         "Curso E", "Curso F", 
                                         "Curso G")))

student_assessment <- read_csv("data/studentAssessment.csv")

student_vle <- data.table::fread("data/studentVle.csv") %>% # tabela grande (450mb)
  tibble() %>% 
  mutate(code_module = factor(code_module, 
                              levels = c("AAA", "BBB", 
                                         "CCC", "DDD", 
                                         "EEE", "FFF", 
                                         "GGG"),
                              labels = c("Curso A", "Curso B", 
                                         "Curso C", "Curso D", 
                                         "Curso E", "Curso F", 
                                         "Curso G")))


```

Nosso dataset possui uma variável chamada `code_module` que contém os códigos dos cursos, como não é tão apresentável eu alterei apenas os labels para nomes mais explicativos. Os labels foram alterados em todos os datasets.
<p style="margin-bottom:40px"></p>

# EDA

Nossa base é bem grande e é composta por diversas tabelas com diversas variáveis que podem ser úteis para nosso modelo de previsão de performance dos estudantes. Justamente por isso, é imprescindível que tenhamos um compreendimento de toda a informação disponível.

Sendo assim, eu resumi os principais aspectos da base de dados e organizei por tópicos para facilitar o entendido.

Sempre inicio minhas análises olhando de perto como está a saúde dos nossos dados, para isso a função `skimr::skim()` é muito útil. Em cada seção que o dataset for utilizado pela primeira vez uma breve descrição será feita seguido por algum insight observado.
<p style="margin-bottom:40px"></p>

## Oferta e Duração dos Cursos

Nosso primeiro dataset será `courses`:

```{r}
# convertendo em datas
courses_v1_tbl <- courses %>% 
  mutate(presentation_date = case_when(code_presentation == "2013J" ~ "2013/02/01",
                                       code_presentation == "2013B" ~ "2013/10/01",
                                       code_presentation == "2014J" ~ "2014/02/01",
                                       TRUE ~ "2014/10/01"),
         presentation_date = as.Date(presentation_date, tryFormats = c("%Y/%m/%d")))

skim(courses_v1_tbl)

```
<p style="margin-bottom:40px"></p>

Neste dataset temos informações sobre os cursos oferecidos na base de dados. São sete no total e foram divididos de A a G, além disso temos também as data em que cada um deles passa a ser ofertado e sua duração em dias.

Não foi detectado nenhum missing value até o momento. 

Observamos que alguns cursos são oferecidos em dois períodos diferentes (FEV e AGO) e sempre que o mesmo é ofertado em FEV possue duração maior que quando é ofertado em AGO.

```{r courses_duration, fig.height=4.5, fig.width=8}
# Visualização
courses_v1_tbl %>% 
  ggplot(aes(x = presentation_date,
             y = module_presentation_length,
             group = code_module,
             color = module_presentation_length < 250)) +
  geom_line(color = "gray60", 
            alpha = .4, 
            linetype = 2) +
  geom_point(size = 2, 
             show.legend = FALSE) +
  scale_color_manual(values = pallete_disc) +
  scale_x_date(breaks = as.Date(c("2013-02-01", "2013-10-01", "2014-02-01", "2014-10-01")),
               minor_breaks = as.Date(c("2013-02-01", "2013-10-01",
                                        "2014-02-01", "2014-10-01")),
               date_labels = "%Y-%m") +
  facet_wrap(~code_module) +
  labs(x = "Data de Oferta dos Cursos",
       y = "Duração em dias") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

No gráfico acima o **<span style="color:#12A661">primeiro período</span>** do ano possui menor carga horária total (em dias), comparado ao **<span style="color:#1495B3">segundo período</span>**.
<p style="margin-bottom:40px"></p>

## Perfomance vs Duração

Visto que o mesmo curso pode ser ofertado por períodos mais longos e mais curtos, pode ser interessante investigar se tal fator provoca alguma consequência nas notas dos estudantes. Para observar se existe relação entre performance e duração do curso precisamos analisar o dataset `assessments`.

```{r}
# convertendo em datas
assessments_v2_tbl <- assessments %>% 
  mutate(presentation_date = case_when(code_presentation == "2013J" ~ "2013/02/01",
                                       code_presentation == "2013B" ~ "2013/10/01",
                                       code_presentation == "2014J" ~ "2014/02/01",
                                       TRUE ~ "2014/10/01"),
         presentation_date = as.Date(presentation_date, tryFormats = c("%Y/%m/%d")),
         assessment_date = presentation_date + date)

assessments_v2_tbl %>% skim()

```
<p style="margin-bottom:40px"></p>

Esse dataset é onde estão os dados sobre as avaliações dos alunos, mais precisamente quando cada avaliação deve ser feita. Temos um total de 8 variáveis e quatro diferentes tipos: categórica, data, fator e numérico.

Algumas variáveis nós já conhecemos, mas outras não, como por exemplo:

- **id_assessment:** código de identificação de cada avaliação.
- **date:** data final de entrega do respectivo exame, sendo o `presentation_date` o dia 0.
- **weight:** peso de cada avaliação, em um curso a soma dos tipos de testes tem que dar 100 com exceção do Exam que sozinho conta 100.
- **assessment_type:** tipo de teste
  - *TMA:* Tutor Marked Assessment (avaliação assistida pelo tutor)
  - *CMA:* Computer Marked Assessment (avaliação assistida por computador)
  - *EXAM:* Final Exam (exame final)
  
Os missing values observados nos dados são explicados na documentação da base de dados da OU. Eles dizem que quando a data do Exame final está faltando é por que ocorreu ao final da última semana de apresentação.

Vamos então utilizar o dataset de `courses` (que contém a duração dos cursos) para encontrar a data dos exames finais e corrigir esses missing values.

```{r}
# realizando um join, é possível obter a data dos missing values
assessments_v3_join_tbl <- assessments_v2_tbl %>% 
  left_join(courses, by = c("code_module", "code_presentation")) %>% 
  mutate(assessment_date = case_when(is.na(assessment_date) ~ (presentation_date + module_presentation_length - 6),
                                     TRUE ~ assessment_date),
         code_module = as.factor(code_module))

```

Ainda no intuito de relacionar performance e duração dos cursos precisamos checar mais dois datasets, o `student_assessment` e o `student_info`.

```{r}
skim(student_assessment)

```
<p style="margin-bottom:40px"></p>

Esse é um dataset maior que contém informações muito úteis sobre os scores de cada estudante em cada tipo de avaliação que foi realizada no semestre, e a data em que foi submetido.

Temos também uma variável chamada `is_banked`, que indica quando o aluno reutilizou algum teste anterior. Além disso, a variação das notas vai de 0 a 100, sendo as menores de 40 indicadas como reprovação (*fail*).

Todas as variáveis são numéricas e com diferentes níveis de skewness. Além disso temos alguns missing values que serão analisados mais a fundo em outras etapas. Vamos agora observar `student_info`. 

```{r}
skim(student_info)

```
<p style="margin-bottom:40px"></p>

Novamente um dataset maior, com informações mais específicas sobre os estudantes:

- gender: gênero
- region: região demográfica
- highest_education: grau de educação mais alto
- imd_band: parâmetro qualitativo dado a localidade de moradia do estudante, quanto menor o valor mais carente é o local.
- age_band: faixa etária
- num_of_prev_attempts: número de vezes que o estudante já tentou o curso
- studied_credits: número total de créditos do curso que o estudante está cursando
- disability: apresenta ou não alguma deficiência
- final_result: se foi aprovado ou não

Temos ainda a presença de alguns valores missing (1111) na variável imd_band. Que também serão analisados em outras etapas.

Juntando os datasets vistos até aqui nesta seção, podemos criar o seguinte gráfico:

```{r score_period, fig.height=4, fig.width=8}
# Para isso, faremos um join
assem_demog_info_tbl <- student_assessment %>% 
  left_join(student_info, by = "id_student") %>%
  left_join(assessments_v3_join_tbl, by = "id_assessment")

# Selecionando colunas de interesse
assem_demog_info_v1_tbl <- assem_demog_info_tbl %>% 
  rename(code_module = code_module.x, code_presentation = code_presentation.x) %>% 
  select(-code_module.y, -code_presentation.y)

# Visualização
assem_demog_info_v1_tbl %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10"))) %>% 
  group_by(code_presentation, code_module) %>% 
  summarise(avg = mean(score, na.rm = TRUE)) %>%
  ungroup() %>% 
  ggplot(aes(x = code_presentation,
             y = avg,
             color = code_module == "Curso B",
             group = code_module)) +
  geom_line(show.legend = FALSE) +
  scale_color_manual(values = c("gray70", "#12A661")) +
  geom_point(size = 2, show.legend = FALSE) +
  facet_wrap(~code_module) +
  theme_minimal() +
  labs(
    x = "Data de oferta dos cursos",
    y = "Média dos scores finais"
  )

```

Vemos que mesmo com uma redução considerável na carga horária dos cursos **(30 a 40 dias)** quando ofertados em diferentes períodos, no geral a performance dos estudantes não sofreu nenhuma mudança significativa. Porém, observamos uma queda de mais de 12% quando olhamos para o **<span style="color:#12A661">Curso B</span>**, no período de 2014/02.
<p style="margin-bottom:40px"></p>

## Material de consulta

Mudando um pouco o foco, vamos analisar o dataset que contêm algumas informações sobre a plataforma online da OU, o `vle`.

```{r}
# conversão em data
vle_v1_tbl <- vle %>% 
  mutate(presentation_date = case_when(code_presentation == "2013J" ~ "2013/02/01",
                                       code_presentation == "2013B" ~ "2013/10/01",
                                       code_presentation == "2014J" ~ "2014/02/01",
                                       TRUE ~ "2014/10/01"),
         presentation_date = as.Date(presentation_date, tryFormats = c("%Y/%m/%d")))

skim(vle_v1_tbl)


```
<p style="margin-bottom:40px"></p>

Aqui temos um registro de todos os materiais disponíveis na plataforma online da OU e também o período indicado para utilização do material. Também temos a presença de muitos valores missing (5243) na variável week_from e week_to.

Como essas variáveis são referentes a semana destinada para se fazer uso do material, acredito que alguns materiais não possuem tal restrição, logo não possuíndo week_from nem week_to.

```{r resource, fig.height=4, fig.width=10}
vle_v2_grouped_tbl <- vle_v1_tbl %>% 
  group_by(code_module, presentation_date, activity_type) %>% 
  summarise(count = n()) %>% 
  ungroup()

# temos mais de 20 formas de interação com a plataforma o que torna difícil a visualização 
# vamos então exibir e selecionar as principais
vle_v3_grouped <- vle_v1_tbl %>% 
  mutate(year = year(presentation_date),
         month = month(presentation_date)) %>% 
  select(-id_site, -code_module, -code_presentation, -week_from, -week_to, -presentation_date, -month) %>%
  group_by(year, activity_type) %>% 
  summarise(count = n()) %>% 
  ungroup()
  
inter <- vle_v3_grouped %>%   
  group_by(year) %>% 
  slice_max(activity_type, n = 10) %>% 
  ungroup() %>% 
  mutate(year = as_factor(year),
         activity_type = tidytext::reorder_within(activity_type, count, year))

inter %>% 
  ggplot(aes(x = activity_type,
             y = count,
             fill = activity_type == "oucontent___2014")) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c("gray70", "#12A661")) +
  facet_wrap(~year, scales = "free_y") +
  coord_flip(ylim = c(0, 1500)) +
  scale_x_reordered() +
  theme_minimal() +
  labs(y = "Quantidade de Material Ofertado",
       x = "Tipo de Material Disponível")


```

A partir do gráfico acima vemos que a OU (Open University) oferece diversos materiais para auxiliar seus estudantes. Além disso, com o passar do tempo, houve aumento da quantidade de material em recursos já disponíveis, assim como a **<span style="color:#12A661">adição de novos</span>**.
<p style="margin-bottom:40px"></p>

```{r}
tot_material <- inter %>% group_by(year) %>% summarise(tot = sum(count)) %>% pull(tot)
tot_material_2013 <- tot_material[1] 
tot_material_2014 <- tot_material[2]
```

Apesar do aumento na quantidade total de materiais ofertados ao longo do tempo: **`r tot_material_2013`** em 2013 e **`r tot_material_2014`** em 2014, esse comportamento não é linear quando analisamos curso a curso. E curiosamente, no curso B, no mesmo período que houve menos oferta de material **<span style="color:#12A661">(mais de 100 recursos a menos)</span>**, é o período que observamos uma queda na média do score final dos estudantes.

```{r resource_class, fig.height=4, fig.width=10}
# todo material disponível no ambiente online (virtual learning environment)
vle_v1_tbl %>%
  group_by(code_presentation, code_module) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10"))) %>%
  ggplot(aes(x = code_presentation,
             y = count)) +
  geom_segment( aes(x = code_presentation, xend = code_presentation, y=0, yend = count), color="grey") +
  geom_point(size=4, aes(color = code_module == "Curso B"), show.legend = FALSE) +
  scale_color_manual(values = c("gray70", "#12A661")) +
  facet_wrap(~code_module) + 
  theme_minimal() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.border = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  labs(
    x = "Data de Oferta dos Cursos",
    y = "Quantidade de Material Ofertado"
  )


```
<p style="margin-bottom:40px"></p>


## Período das Avaliações

Como nós já vimos nos datasets anteriores, cada curso possui um conjunto de avaliações que se alternam em três diferentes tipos. Temos as intermediárias **<span style="color:#12A661">(TMA)</span>** e **<span style="color:#A67B24">(CMA)</span>** ao longo do período do curso e avaliações finais **<span style="color:#8F1F17">(Exam)</span>** na última semana. Porém, o CMA ocorre para todas as disciplinas e nem em todos períodos. Por ser uma avaliação assistida por computador, presume-se que não se aplica a todos os cursos, mas não temos mais informações para testar essa hipótese.

Abaixo nós podemos visualizar quando que cada avaliação é realizada por curso e por período.

```{r period_tests, fig.height=4, fig.width=10}
# Período de avaliações
assessments_v3_join_tbl %>% 
  ggplot(aes(x = assessment_date,
             y = fct_rev(code_module),
             fill = assessment_type)) +
  geom_tile() +
  facet_wrap(~presentation_date, scales = "free") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_fill_manual(values = c("#A67B24", "#8F1F17", "#12A661")) +
  labs(
    x = "Data da Avaliação",
    y = "",
    fill = "Tipo de Avaliação"
  ) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank()) 

```
<p style="margin-bottom:40px"></p>


## Taxa de Reprovação

Nesta seção e nas próximas iremos analisar a performance dos estudantes, buscando relacionar com alguns outras features. 

Primeiro ponto será analisar a taxa de reprovação dos estudantes, a qual foi calculada da seguinte forma:

<p style="margin-bottom:40px"></p>
<center>
$taxa_{reprovação} = \frac{estudantes\space reprovados}{total\space de\space estudantes}$
</center>
<p style="margin-bottom:40px"></p>

Dessa forma, nós temos para cada período e curso um fator que pode ser comparado, o qual vamos visualizar no gráfico abaixo.

```{r fail_ratio, fig.height=4, fig.width=7}
# taxa de reprovação
student_prop <- student_info %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"))) %>% 
  group_by(code_presentation, code_module) %>% 
  summarise(count = n()) %>% 
  ungroup()
  
student_prop_2 <- student_info %>%   
  filter(final_result == "Fail") %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"))) %>% 
  group_by(code_presentation,code_module) %>% 
  summarise(count_2 = n()) %>% 
  ungroup() %>% 
  select(count_2)

student_fail_ratio <- bind_cols(student_prop, student_prop_2) %>% 
  mutate(prop = count_2/count) %>% 
  select(code_presentation, code_module, prop) %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10")))

student_fail_ratio %>% 
  filter(!code_module %in% c("Curso A", "Curso C")) %>% 
  ggplot(aes(x = code_presentation,
             y = prop,
             color = code_presentation %in% c("2013/10", "2014/10"),
             group = code_module)) +
  geom_line(size = 1, color = "gray80") +
  geom_point(size = 3) +
  geom_text(data = student_fail_ratio %>% filter(code_presentation == "2013/02",
                                                 code_module != "Curso A"), 
            aes(label = code_module, x = 0.8), 
            fontface = "bold", 
            size = 3, 
            color = "gray60") +
  geom_text(data = student_fail_ratio %>% filter(code_presentation == "2014/10",
                                                 code_module != "Curso C"), 
            aes(label = code_module, x = 4.3), 
            color = "gray60", 
            size = 3.5, 
            fontface = "bold") +
  ylim(0.15, 0.32) +
  scale_color_manual(values = c("gray80", "#12A661")) +
  theme_minimal() +
  guides(color = FALSE) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(
    x = "Data de Oferta dos Cursos",
    y = "Taxa de reprovação"
  )


```

O que vemos é que apesar da média de performance permanecer praticamente sem alteração ao longo dos períodos (seções anteriores), a **taxa de reprovação** costuma ser um pouco **<span style="color:#12A661">maior</span>** nos períodos mais curtos (*considerando os cursos que foram ofertados mais de 3 vezes*).
<p style="margin-bottom:40px"></p>


## Taxas de Desistência e Aprovação

Aqui a taxa calculada foi a desistência de forma bem semelhante a anterior:
<p style="margin-bottom:40px"></p>
<center>
$taxa_{reprovação} = \frac{estudantes\space desistentes}{total\space de\space estudantes}$
</center>
<p style="margin-bottom:40px"></p>

```{r withdrawn_ratio, fig.height=6, fig.width=8}
# taxa de desistência
student_prop_3 <- student_info %>%   
  filter(final_result == "Withdrawn") %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"))) %>% 
  group_by(code_presentation,code_module) %>% 
  summarise(count_2 = n()) %>% 
  ungroup() %>% 
  select(count_2)

student_withdrawn_ratio <- bind_cols(student_prop, student_prop_3) %>% 
  mutate(prop = count_2/count) %>% 
  select(code_presentation, code_module, prop) %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10")))

student_withdrawn_ratio %>% 
  ggplot(aes(x = code_presentation,
             y = prop,
             color = code_module %in% c("Curso A", "Curso G"),
             group = code_module)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_text(data = student_withdrawn_ratio %>% filter(code_presentation == "2013/02"), aes(label = code_module, x = 0.8), fontface = "bold", size = 3, color = "gray60") +
  geom_text(data = student_withdrawn_ratio %>% filter(code_presentation == "2013/02",
                                                      code_module %in% c("Curso A", "Curso G")), aes(label = code_module, x = 0.8), fontface = "bold", size = 3, color = "#12A661") +
  geom_text(data = student_withdrawn_ratio %>% filter(code_presentation == "2014/10"), aes(label = code_module, x = 4.2), color = "gray60", size = 3.5, fontface = "bold") +
  geom_text(data = student_withdrawn_ratio %>% filter(code_presentation == "2014/10",
                                                      code_module == "Curso G"), aes(label = code_module, x = 4.2), color = "#12A661", size = 3.5, fontface = "bold") +
  geom_text(data = student_withdrawn_ratio %>% filter(code_presentation == "2014/02",
                                                      code_module == "Curso A"), aes(label = code_module, x = 3.2), color = "#12A661", size = 3.5, fontface = "bold") +
  scale_color_manual(values = c("gray80", "#12A661")) +
  theme_minimal() +
  guides(color = FALSE) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        text = element_text(size = 15)) +
  labs(
    x = "Data de Oferta dos Cursos",
    y = "Taxa de Desistência"
  )

```

Analisando a taxa de desitência foi observado que os cursos **<span style="color:#12A661">A e G</span>** apresentam as menores taxas de desistência. 
<p style="margin-bottom:40px"></p>

## Taxa de Aprovação

Aqui a taxa calculada foi a aprovação de forma bem semelhante as anteriores:
<p style="margin-bottom:40px"></p>
<center>
$$taxa_{reprovação} = \frac{estudantes\space aprovados}{total\space de\space estudantes}$$
</center>
<p style="margin-bottom:40px"></p>

```{r pass_ratio, fig.height=6, fig.width=8}
# taxa de aprovados
student_prop_4 <- student_info %>%   
  filter(final_result == "Pass") %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"))) %>% 
  group_by(code_presentation,code_module) %>% 
  summarise(count_2 = n()) %>% 
  ungroup() %>% 
  select(count_2)

student_pass_ratio <- bind_cols(student_prop, student_prop_4) %>% 
  mutate(prop = count_2/count) %>% 
  select(code_presentation, code_module, prop) %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10"))) 

student_pass_ratio %>% 
  ggplot(aes(x = code_presentation,
             y = prop,
             color = code_module == "Curso A",
             group = code_module)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  geom_text(data = student_pass_ratio %>% filter(code_presentation == "2013/02"), aes(label = code_module, x = 0.8), fontface = "bold", size = 3, color = "gray60") +
  geom_text(data = student_pass_ratio %>% filter(code_presentation == "2013/02",
                                                      code_module == "Curso A"), aes(label = code_module, x = 0.8), fontface = "bold", size = 3, color = "#12A661") +
  geom_text(data = student_pass_ratio %>% filter(code_presentation == "2014/10"), aes(label = code_module, x = 4.2), color = "gray60", size = 3.5, fontface = "bold") +
  geom_text(data = student_pass_ratio %>% filter(code_presentation == "2014/02",
                                                      code_module == "Curso A"), aes(label = code_module, x = 3.2), color = "#12A661", size = 3.5, fontface = "bold") +
  scale_color_manual(values = c("gray80", "#12A661")) +
  theme_minimal() +
  guides(color = FALSE) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        text = element_text(size = 15)) +
  labs(
    x = "Data de Oferta dos Cursos",
    y = "Taxa de Aprovação"
  )

```

Analisando a taxas de aprovação foi observado que o curso **<span style="color:#12A661">Curso A</span>** apresenta a maior valor, aproximadamente 7 a cada 10 estudantes são aprovados.
<p style="margin-bottom:40px"></p>

## Quantidade de Estudantes por Gênero

Entre homens e mulheres presentes na nossa base, vale a pena analisar como essa feature está relacionada aos cursos.

```{r, echo=FALSE, fig.height=4, fig.width=10}
# quantidade de estudantes por sexo
student_prop_gender <- student_info %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10"))) %>%
  mutate(gender = factor(gender,
                         levels = c("F", "M"),
                         labels = c("Feminino", "Masculino"))) %>% 
  group_by(code_presentation, code_module, gender) %>% 
  summarise(count = n()) %>% 
  ungroup()

student_prop_gender %>%
  ggplot(aes(x = code_presentation,
             y = count,
             fill = gender)) +
  geom_col(position = "dodge") +
  facet_wrap(~code_module) +
  scale_fill_manual(values = c("#12A661", "#014034")) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(
    x = "Data de Oferta dos Cursos",
    y = "Quantidade de Estudantes",
    fill = "Gênero"
  )

```

Os dados mostram uma população predominantemente feminina em 2 cursos específicos: **Curso B e Curso G**. Em todas os outros temos mais homens participando dos cursos. Tal aderência pode ter relação com características intrínsecas dos respectivos cursos e infelizmente não temos dados para testar essa hipótese.
<p style="margin-bottom:40px"></p>

## Distribuições dos Scores Finais

Até o momento nós apenas visualizamos as notas finais e não a distribuição de notas ao longo do tempo e por curso. Vamos então analisar o gráfico abaixo:

```{r, fig.height=4, fig.width=10}
# perfil de destribuição dos scores
assem_demog_info_v1_fct_tbl <- assem_demog_info_v1_tbl %>% 
  mutate(code_presentation = factor(code_presentation, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10")))

assem_demog_info_v1_fct_tbl %>% 
  ggplot(aes(x = score,
             y = fct_rev(code_presentation),
             fill = code_module %in% c("Curso B", "Curso G"))) + 
  geom_density_ridges(gradient_lwd = 1., size = .2) +
  scale_fill_manual(values = c("gray90", "#12A661")) +
  facet_wrap(~code_module) +
  scale_x_continuous(expand = c(0, 0)) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(
    x = "Scores",
    y = "Data de Oferta dos Cursos"
  ) +
  guides(fill = FALSE)

```

O que observa-se é um comportamento diferenciado em 2 cursos (**<span style="color:#12A661">Curso B e Curso G</span>**). Ambos possuem um pico de estudantes com performance muito elevada **(acima de 90 pontos)**. 

Também é possível notar que todos os cursos mantém um perfil característico de distribuição dos scores ao longo do tempo. Tal fator nos leva a acreditar que existe uma manuntenção da forma como os cursos vem sendo trabalhados e também uma manuntenção do perfil de aluno que normalmente opta por cada curso.
<p style="margin-bottom:40px"></p>

## Distribuição da Taxa de Acesso à Plataforma

Aqui nós iremos analisar uma base que ainda não havia sido trabalhada nesta EDA, a `student_vle`. Esse dataset contém mais de 10M de observações de registro de cada estudante na plataforma online, onde foi registrado a quantidade de clicks e a data.

A data aqui está registrada em dias, sendo *dia 0* o dia de início do curso e *dias negativos* dias anteriores ao início do curso.

Como vimos anteriormente, existem alunos que possuem alta performance (score alto), como também estudantes que tem notas mais inferiores. Vamos então identificar se existe alguma relação entre as notas dos estudantes e o perfil de acesso a plataforma.

Para ser possível de comparação, precisamos de taxas de acesso a plataforma e também categorizar os estudantes entre alta perfomance, performance mediana e baixa performance.

- alta performance: score acima de 90
- performance mediana: score entre 50 e 90
- baixa performance: score abaixo de 50

E as taxas foram calculadas assim:

1. identificação da quantidade de clicks dos estudantes (high, med, low).
1. soma da quantidade de cliques por curso e estudante.
1. soma do total de estudantes por curso e período.
1. divisão do item 2 pelo total de estudantes do periodo e curso correspondente.

Sendo assim, para os estudantes de alta performance temos:

```{r, fig.height=4.5, fig.width=11}
clicks_students_period <- student_vle %>% 
  group_by(code_presentation, id_student) %>% 
  summarise(clicks = sum(sum_click)) %>% 
  ungroup()

prop_join <- function(high_score_students) {

  student_vle_interation <- high_score_students %>%
    select(-id_assessment, -date_submitted, -is_banked, -num_of_prev_attempts, -studied_credits, -disability, -assessment_type, -assessment_date, -module_presentation_length) %>%
    left_join(clicks_students_period, by = "id_student")

  student_clicks <- student_vle_interation %>%
    group_by(code_presentation.y, id_student) %>%
    summarise(quantity = sum(clicks)) %>%
    ungroup()

  student_total_period <- student_vle_interation %>%
    distinct(code_presentation.y, id_student) %>%
    group_by(code_presentation.y) %>%
    summarise(count = n()) %>%
    ungroup() %>%
    drop_na()

  ratio_click_student <- student_clicks %>%
    left_join(student_total_period, by = "code_presentation.y") %>%
    mutate(prop = quantity / count) %>%
    select(-quantity, -count)


  remove(student_vle_interation, student_clicks, student_total_period)

  return(ratio_click_student)

}

# high_score_students
high_score_students <- assem_demog_info_v1_tbl %>%
  filter(score > 90)

# median_score_students
median_score_students <- assem_demog_info_v1_tbl %>%
  filter(between(score, 50, 90))

# low_score_students
low_score_students <- assem_demog_info_v1_tbl %>%
  filter(between(score, 0, 50))


ratio_high <- prop_join(high_score_students)
ratio_medium <- prop_join(median_score_students)
ratio_low <- prop_join(low_score_students)

ratio_high_fct <- ratio_high %>% 
  mutate(code_presentation = factor(code_presentation.y, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10")))

ratio_medium_fct <- ratio_medium %>% 
  mutate(code_presentation = factor(code_presentation.y, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10")))

ratio_low_fct <- ratio_low %>% 
  mutate(code_presentation = factor(code_presentation.y, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10")))

ratio_high_fct %>%
  drop_na() %>%
  ggplot(aes(x = prop, y = fct_rev(code_presentation))) +
  geom_point(shape = "|", size = 8, alpha = .1, color = "#165914") +
  geom_density_ridges(scale = .8, alpha = .8, fill = "#12A661", color = FALSE) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(
    x = "Taxa de Acesso à Plataforma",
    y = "Data de Oferta dos Cursos"
  )

```


Abaixo estão as distribuições do acessso de estudantes que tiveram **scores entre 50 e 90** (Medium).

```{r, fig.height=4.5, fig.width=11}
ratio_medium_fct %>% 
  drop_na() %>%
  ggplot(aes(x = prop, y = fct_rev(code_presentation))) +
  geom_point(shape = "|", size = 8, alpha = .1, color = "#165914") +
  geom_density_ridges(scale = .8, alpha = .8, fill = "#12A661", color = FALSE) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(
    x = "Taxa de Acesso à Plataforma",
    y = "Data de Oferta dos Cursos"
  )
```

E abaixo estão os estudantes que foram bem mal nas avaliações, tiveram um **score menor que 50** (Low).

```{r, fig.height=4.5, fig.width=11}
ratio_low_fct %>% 
  drop_na() %>% 
  ggplot(aes(x = prop, y = fct_rev(code_presentation))) +
  geom_point(shape = "|", size = 8, alpha = .1, color = "#165914") +
  geom_density_ridges(scale = .8, alpha = .8, fill = "#12A661", color = FALSE) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(
    x = "Taxa de Acesso à Plataforma",
    y = "Data de Oferta dos Cursos"
  )

```

Em resumo das três distribuições vistas acima, temos que:

- todas as distribuições possuem skewness positivo
- as distribuições dos estudantes de alta performance apresentam maior taxa de acesso à plataforma.
- as distribuições dos estudantes de performance mediana apresentam também taxa de acesso à plataforma mediana.
- as distribuições dos estudantes de performance baixa apresentam a mais baixa taxa de acesso à plataforma.

Todas essas observações foram retiradas apenas pelo visual, mas a seguir vamos verificar a variação da média da taxa de acesso à plataforma.
<p style="margin-bottom:40px"></p>

## Média da Taxa de Acesso à Plataforma

Após ter uma visão geral do comportamento do acesso à plataforma entre diferentes perfis de estudantes, fica claro ao ver as médias que quem mais acessa os recursos oferecidos pela OU são os estudantes de alto desempenho. 

```{r, fig.height=4, fig.width=8}
# tabela com stats descritivas

desc_stats_low <- ratio_low %>% 
  mutate(group = "Low") %>% 
  group_by(code_presentation.y, group) %>% 
  summarise(avg = mean(prop, na.rm = TRUE),
            sd = sd(prop, na.rm = TRUE),
            med = median(prop, na.rm = TRUE)) %>% 
  ungroup()

desc_stats_medium <- ratio_medium %>% 
  mutate(group = "Medium") %>% 
  group_by(code_presentation.y, group) %>% 
  summarise(avg = mean(prop, na.rm = TRUE),
            sd = sd(prop, na.rm = TRUE),
            med = median(prop, na.rm = TRUE)) %>% 
  ungroup()

desc_stats_high <- ratio_high %>% 
  mutate(group = "High") %>% 
  group_by(code_presentation.y, group) %>% 
  summarise(avg = mean(prop, na.rm = TRUE),
            sd = sd(prop, na.rm = TRUE),
            med = median(prop, na.rm = TRUE)) %>% 
  ungroup()


desc_stats <- bind_rows(desc_stats_low, desc_stats_high, desc_stats_medium) %>% 
  drop_na() %>% 
  mutate(code_presentation.y = factor(code_presentation.y, 
                                    levels = c("2013J", "2013B", "2014J", "2014B"),
                                    labels = c("2013/02", "2013/10", "2014/02", "2014/10")))

desc_stats %>% 
  ggplot(aes(x = code_presentation.y,
             y = avg,
             color = group,
             group = group)) +
  geom_line(size = 2) +
  geom_point(size = 4) +
  geom_text(data = desc_stats %>% filter(code_presentation.y == "2013/02"), aes(label = group, x = 0.8), fontface = "bold", size = 4) +
  geom_text(data = desc_stats %>% filter(code_presentation.y == "2014/10"), aes(label = group, x = 4.2), fontface = "bold", size = 4) +
  scale_color_manual(values = c("#216125", "#529E36", "#ACE058")) +
  theme_minimal() +
  guides(color = FALSE) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(
    x = "Data de Oferta dos Cursos",
    y = "Média da Taxa de Acesso à Plataforma"
  )

```

Vale a ressalva que apenas o período de 2013/10 apresentou uma inversão entre o acesso a plataforma dos alunos de notas medianas e os de alta performance. Também é possível ver que nos períodos de menor carga horária tem-se um aumento na taxa de acesso, um hipótese seria que os estudantes precisam utilizar com mais afinco materiais fornecidos pela OU quando possuem menos tempo para estudar por outros recursos.

```{r, include=FALSE}
# boxplots
ratio_high %>% 
  ggplot(aes(x = prop,  y = code_presentation.y)) +
  geom_boxplot()

ratio_medium %>% 
  ggplot(aes(x = prop,  y = code_presentation.y)) +
  geom_boxplot()

ratio_low %>% 
  ggplot(aes(x = prop,  y = code_presentation.y)) +
  geom_boxplot()

```
<p style="margin-bottom:40px"></p>

## Perfil dos Acessos à Plataforma

No gráfico seguinte é visto o acesso à plataforma relacionado aos dados ao longo da duração do curso no eixo horizontal (em dias), e em conjunto com os cursos e o respectivo período.

```{r, fig.height=4.5, fig.width=11}
# verificando período de acesso do low
student_click_w_date <- student_vle %>% 
  group_by(code_presentation, code_module, id_student, date) %>% 
  summarise(clicks = sum(sum_click, na.rm = TRUE)) %>% 
  ungroup()

prop_period_join <- function (ratio_high_fct) {
  
  access_period <- ratio_high_fct %>% 
    select(-prop, -code_presentation.y) %>% 
    left_join(student_click_w_date, by = "id_student")
  
  access_period_clicks <- access_period %>% 
    mutate(date = as.factor(date)) %>% 
    group_by(code_presentation.y, code_module, date) %>% 
    summarise(total_clicks = sum(clicks, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(code_presentation.y = factor(code_presentation.y, 
                                      levels = c("2013J", "2013B", "2014J", "2014B"),
                                      labels = c("2013/02", "2013/10", "2014/02", "2014/10")))
  
  
}

period_access_high <- prop_period_join(ratio_high_fct)
period_access_medium <- prop_period_join(ratio_medium_fct)
period_access_low <- prop_period_join(ratio_low_fct)

period_acess_geral <- bind_rows(period_access_low, period_access_medium, period_access_high)

g1 <- period_acess_geral %>% 
  drop_na() %>% 
  ggplot(aes(x = date,
             y = total_clicks)) +
  geom_col(alpha = .3) +
  geom_smooth(data = period_acess_geral %>% drop_na() %>%  mutate(date = as.numeric(date)), 
              mapping = aes(x = date, y = total_clicks),
              span = .07,
              size = .7,
              se = FALSE,
              color = "#12A661") +
  scale_x_discrete(breaks = c(-10, 50, 100, 150, 200, 250, 295)) +
  facet_grid(code_module ~ code_presentation.y, scales = "free_y") +
  theme_minimal() +
  guides(color = FALSE) +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(
    x = "Período de Duração do Curso (dias)",
    y = "Quantidade de Registros de Acesso à Plataforma"
  )

g1

```

Veja que a **<span style="color:#12A661">linha de tendência</span>**  apresenta diferentes picos durante um determinado período. Esses picos são referentes aos períodos das avaliações, sugerindo que os estudantes acessam mais os recursos quando se aproxima das datas das avaliações.
<p style="margin-bottom:40px"></p>

## Características por Região

E por fim, vamos dar uma olhada nos dados demográficos.

```{r, out.width="100%", fig.align="center"}
# alterando nomes das regiões pelo nome correto
assem_demog_info_v2_tbl <- assem_demog_info_v1_tbl %>% 
  mutate(region = case_when(region == "East Anglian Region" ~ "East of England",
                            region == "East Midlands Region" ~ "East Midlands (England)",
                            region == "Ireland" ~ "Northern Ireland",
                            region == "London Region" ~ "London",
                            region == "North Region" ~ "North East (England)",
                            region == "North Western Region" ~ "North West (England)",
                            region == "South East Region" ~ "South East (England)",
                            region == "South West Region" ~ "South West (England)",
                            region == "West Midlands Region" ~ "West Midlands (England)",
                            region == "Yorkshire Region" ~ "Yorkshire and The Humber",
                            TRUE ~ region)) %>% 
  filter(region != "South Region")

# Os dados consideram apenas um Sul em algumas categorizações
# Aqui iremos dividir em 50% para South East e 50% para South West

assem_demog_info_v3_south50_tbl <- assem_demog_info_v1_tbl %>% 
  filter(region == "South Region") %>% 
  slice_head(n = 10000) %>% 
  mutate(region = case_when(region == "South Region" ~ "South East (England)",
                            TRUE ~ region))

assem_demog_info_v3_south100_tbl <- assem_demog_info_v1_tbl %>% 
  filter(region == "South Region") %>% 
  slice_tail(n = 10883) %>% 
  mutate(region = case_when(region == "South Region" ~ "South West (England)",
                            TRUE ~ region))

# dataset a ser utilizado
assem_demog_info_v3_tbl <- bind_rows(assem_demog_info_v2_tbl, assem_demog_info_v3_south50_tbl, assem_demog_info_v3_south100_tbl) %>% 
  mutate(gender = factor(gender,
                         levels = c("F", "M"),
                         labels = c("Feminino", "Masculino"))) %>% 
  mutate(age_band = factor(age_band, 
                           levels = c("0-35", "35-55", "55<="),
                           labels = c("0 à 35 anos",
                                      "35 à 55 anos",
                                      "maior que 55 anos")))


# para trabalhar com mapas, iremos utilizar um tipo de arquivo chamado shapefiles
# o mesmo pode ser encontrado na internet
uk_map <- read_sf("data/shapefile/NUTS_Level_1__January_2018__Boundaries-shp/NUTS_Level_1__January_2018__Boundaries.shp")

uk_map_filter_quantity_students <- assem_demog_info_v3_tbl %>% 
  count(region) %>% 
  inner_join(uk_map, by = c("region" = "nuts118nm"))

uk_map_filter_gender <- assem_demog_info_v3_tbl %>% 
  group_by(region, gender) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  inner_join(uk_map, by = c("region" = "nuts118nm"))

plot_map_by_category <- function(data, var) {
  
  # expressão não avaliada
  var_exrp <- enquo(var)
  
  # agrupando pela variável de interesse
  uk_map_filter <- data %>% 
  group_by(region, !!var_exrp) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  inner_join(uk_map, by = c("region" = "nuts118nm"))
  
  # retorna um objeto ggplot
  ggplot() +
    geom_sf(data = uk_map_filter, aes(geometry = geometry, 
                                      fill = n, 
                                      text = str_glue("{region}
                                                      {n} Estudantes")), 
            size = .4) +
    facet_wrap(as.formula(paste("~", var_exrp))) +
    scale_fill_gradient(high = "#12A661", low = "#F2F78F") +
    theme_minimal() +
    guides(fill = FALSE) +
    theme(panel.grid = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_blank())
  
}

interactive_plot_gender <- assem_demog_info_v3_tbl %>%
plot_map_by_category(var = gender) %>%
  plotly::ggplotly(tooltip = "text", width=500, height=300) %>%
  style(hoveron = "text")

interactive_plot_gender

interactive_plot_ageband <- assem_demog_info_v3_tbl %>%
plot_map_by_category(var = age_band) %>%
  plotly::ggplotly(tooltip = "text", width=500, height=300) %>%
  style(hoveron = "text")

interactive_plot_ageband 

```
<p style="margin-bottom:40px"></p>

Veja que no **Sul do Reino Unido** está localizado a **<span style="color:#12A661">maior parcela</span>** dos estudantes que estiveram matriculados na OU e em segundo lugar a Escócia.

Também nota-se que existe maior número de homens do que mulheres, aproximadamente **36% a mais**.

Vemos que a maior fatia dos estudantes possuem entre **0 e 35 anos**, e novamente o Sul e a Escócia concentra maior parcela.

